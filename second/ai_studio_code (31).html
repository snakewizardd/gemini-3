<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EL CORAZÃ“N | DIGITAL FLAMENCO</title>
    <style>
        body { margin: 0; background: #1a0505; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        canvas { position: absolute; top: 0; left: 0; z-index: 1; filter: contrast(1.2); }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            z-index: 10; background: radial-gradient(circle, rgba(0,0,0,0.6), #000);
            transition: opacity 1s;
        }
        button {
            background: #ff3300; color: #fff; border: none; padding: 20px 60px;
            font-size: 24px; letter-spacing: 5px; font-weight: bold;
            box-shadow: 0 0 40px #ff3300; border-radius: 2px; cursor: pointer;
            transition: transform 0.2s;
        }
        button:hover { transform: scale(1.1); background: #ff5500; }
        h1 { color: #ffcc00; text-transform: uppercase; letter-spacing: 10px; font-size: 12px; margin-bottom: 20px; }
        
        #readout {
            position: absolute; bottom: 20px; left: 20px;
            color: #ff5500; font-size: 14px; font-family: monospace;
            z-index: 5; text-transform: uppercase;
        }
    </style>
</head>
<body>

<canvas id="can"></canvas>
<div id="readout">State: Waiting...</div>

<div id="overlay">
    <h1>Phrygian Dominant Engine</h1>
    <button id="start">IGNITE</button>
</div>

<script>
/* ------------------------------------------------------------
   AUDIO ARCHITECTURE: THE LATIN ENGINE
   ------------------------------------------------------------ */
const AudioContext = window.AudioContext || window.webkitAudioContext;
let ctx, master, drive, delay, percussionBus;

// FLAMENCO / SANTANA SCALES
// Key of E Phrygian Dominant (The "Spanish" Sound)
const SCALES = {
    base: [82.41, 164.81], // Low E roots
    runs: [164.81, 174.61, 207.65, 220.00, 246.94, 261.63, 293.66, 329.63, 349.23, 415.30, 440.00] 
    // E, F, G#, A, B, C, D, E (The exotic intervals)
};

/* --- PERCUSSION SYNTHESIS (TIMBALES/CONGAS) --- */
function playTimbale(time, pitch, sharp) {
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    // Ring modulation trick for metallic shell sound
    osc.type = sharp ? 'square' : 'sine'; 
    osc.frequency.setValueAtTime(pitch, time);
    osc.frequency.exponentialRampToValueAtTime(pitch * 0.8, time + 0.1);

    gain.gain.setValueAtTime(0, time);
    gain.gain.linearRampToValueAtTime(0.3, time + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.001, time + 0.3);

    osc.connect(gain);
    gain.connect(master);
    osc.start(time);
    osc.stop(time + 0.4);
    
    triggerVisual(sharp ? 200 : -200, 0, 'drum');
}

function playShaker(time) {
    const bufSize = ctx.sampleRate * 0.05; // Short tick
    const buf = ctx.createBuffer(1, bufSize, ctx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i=0; i<bufSize; i++) data[i] = (Math.random() * 2 - 1);

    const src = ctx.createBufferSource();
    src.buffer = buf;
    const filter = ctx.createBiquadFilter();
    filter.type = 'highpass';
    filter.frequency.value = 6000;
    const gain = ctx.createGain();
    gain.gain.value = 0.05;

    src.connect(filter);
    filter.connect(gain);
    gain.connect(master);
    src.start(time);
}

/* --- THE GUITAR VOICE (THE "SANTANA" TONE) --- */
function setupRig() {
    ctx = new AudioContext();
    master = ctx.createGain();
    master.gain.value = 0.4;
    master.connect(ctx.destination);

    // 1. OVERDRIVE (The "Tube" saturation)
    drive = ctx.createWaveShaper();
    const k = 20; 
    const n = 44100;
    const curve = new Float32Array(n);
    for(let i=0; i<n; i++){
        const x = i * 2 / n - 1;
        // Soft clipping sigmoid
        curve[i] = (3 + k) * x * 20 * (Math.PI / 180) / (Math.PI + k * Math.abs(x));
    }
    drive.curve = curve;

    // 2. DELAY (The "Arena" feel)
    delay = ctx.createDelay();
    delay.delayTime.value = 0.350; // Syncopated delay
    const fb = ctx.createGain();
    fb.gain.value = 0.4;
    delay.connect(fb);
    fb.connect(delay);

    // Chain: Guitar -> Drive -> Delay -> Master
    drive.connect(delay);
    delay.connect(master);
    drive.connect(master); // Direct signal
}

function playNote(freq, duration, type) {
    const t = ctx.currentTime;
    const osc = ctx.createOscillator();
    const osc2 = ctx.createOscillator(); // Detuned layer for thickness
    const env = ctx.createGain();
    const filter = ctx.createBiquadFilter();

    // "Electric Spanish" Tone
    osc.type = 'sawtooth'; // Bite
    osc2.type = 'triangle'; // Body
    osc2.detune.value = 10; // Slight chorus effect

    osc.frequency.setValueAtTime(freq, t);
    osc2.frequency.setValueAtTime(freq, t);

    // Guitar Tone Shaping (The Wah/Voice)
    filter.type = 'lowpass';
    filter.Q.value = 2; // Resonant peak
    filter.frequency.setValueAtTime(600, t);
    filter.frequency.linearRampToValueAtTime(2000, t + 0.1); // "Wah" opening
    filter.frequency.linearRampToValueAtTime(800, t + duration);

    // Attack/Sustain Envelope
    env.gain.setValueAtTime(0, t);
    env.gain.linearRampToValueAtTime(0.3, t + 0.05); // Pick attack
    // "Santana Sustain": Keep volume high, fade slow
    if (type === 'hold') {
        env.gain.linearRampToValueAtTime(0.25, t + duration - 0.5);
    } else {
        env.gain.exponentialRampToValueAtTime(0.1, t + 0.2);
    }
    env.gain.linearRampToValueAtTime(0, t + duration);

    osc.connect(filter);
    osc2.connect(filter);
    filter.connect(env);
    env.connect(drive); // Hit the overdrive amp

    osc.start(t);
    osc2.start(t);
    osc.stop(t + duration + 0.1);
    osc2.stop(t + duration + 0.1);
    
    // Bending Logic (Pitch Wheel)
    if (type === 'hold') {
        // Slow passionate bend up
        osc.frequency.linearRampToValueAtTime(freq + (freq*0.02), t + duration);
        osc2.frequency.linearRampToValueAtTime(freq + (freq*0.02), t + duration);
    }

    triggerVisual(0, 0, 'guitar', freq, type);
}


/* ------------------------------------------------------------
   THE CONDUCTOR: GENERATIVE ALGORITHM
   ------------------------------------------------------------ */
let grooveInterval;
let isPlaying = false;

// 1. THE DRUMMER (Clockwork)
function startGroove() {
    const bpm = 110;
    const beatLen = 60 / bpm;
    let beat = 0;
    let nextTime = ctx.currentTime;

    const schedule = () => {
        while (nextTime < ctx.currentTime + 0.1) {
            // Shakers every 16th note
            playShaker(nextTime);
            playShaker(nextTime + (beatLen/4));
            playShaker(nextTime + (beatLen/2));
            playShaker(nextTime + (beatLen*0.75));

            // Timbales (The "Cascaras" Pattern - Latin Clave-ish)
            // On 1, and-of-2, 4
            const t = nextTime;
            const q = beatLen;
            
            // Bass Pulse (Kick)
            if(beat % 4 === 0) {
                 const k = ctx.createOscillator();
                 const kg = ctx.createGain();
                 k.frequency.setValueAtTime(100, t);
                 k.frequency.exponentialRampToValueAtTime(40, t+0.2);
                 kg.gain.setValueAtTime(1, t);
                 kg.gain.exponentialRampToValueAtTime(0.001, t+0.2);
                 k.connect(kg); kg.connect(master); k.start(t); k.stop(t+0.2);
                 triggerVisual(0,0,'pulse');
            }
            
            // Syncopated Hits
            if (beat % 2 === 0) playTimbale(t + q * 0.75, 400, true); // Syncopated high tom
            if (beat % 4 === 3) playTimbale(t + q * 0.25, 250, false); // Low tom roll

            nextTime += beatLen;
            beat++;
        }
        if(isPlaying) grooveInterval = requestAnimationFrame(schedule);
    };
    schedule();
}

// 2. THE GUITARIST (Improvisation)
function guitaristThinking() {
    if (!isPlaying) return;

    const action = Math.random();
    
    // Choose phrasing style
    if (action < 0.4) {
        // THE FLURRY (Fast Run)
        playRun();
        setTimeout(guitaristThinking, 2000); // Wait for next phrase
    } else if (action < 0.8) {
        // THE PASSION (Long Hold)
        playSoulNote();
        setTimeout(guitaristThinking, 3500); // Long pause after big note
    } else {
        // SILENCE / SPACE
        document.getElementById('readout').innerText = "PHRASE: BREATHING...";
        setTimeout(guitaristThinking, 1000);
    }
}

function playRun() {
    document.getElementById('readout').innerText = "PHRASE: VELOCITY RUN";
    const startIdx = Math.floor(Math.random() * 6); // Start mid-scale
    const len = 4 + Math.floor(Math.random() * 4);
    const direction = Math.random() > 0.5 ? 1 : -1;
    
    let delay = 0;
    for (let i = 0; i < len; i++) {
        // Traverse the Phrygian scale
        let noteIdx = startIdx + (i * direction);
        // Bounce off boundaries
        if(noteIdx < 0) noteIdx = -noteIdx; 
        if(noteIdx >= SCALES.runs.length) noteIdx = SCALES.runs.length - 2;
        
        let note = SCALES.runs[noteIdx];
        
        setTimeout(() => {
            playNote(note, 0.2, 'fast');
        }, delay);
        delay += 90; // 90ms between notes = fast playing
    }
    // End run with a target note
    setTimeout(() => {
        playNote(SCALES.runs[startIdx + (len*direction)] || SCALES.runs[0], 1.5, 'hold');
    }, delay);
}

function playSoulNote() {
    document.getElementById('readout').innerText = "PHRASE: SOUL BEND";
    // Pick a "Juicy" note (The Root or the Flat 2nd/Flat 9 for Flamenco tension)
    const juicyIndices = [3, 7, 10]; // A (4th), E (Root)
    const note = SCALES.runs[juicyIndices[Math.floor(Math.random() * juicyIndices.length)]];
    playNote(note, 3.0, 'hold'); // 3 second sustain
}

/* ------------------------------------------------------------
   VISUAL ENGINE: SPANISH HEAT
   ------------------------------------------------------------ */
const canvas = document.getElementById('can');
const c = canvas.getContext('2d');
let w, h, particles = [];

function resize() { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
window.onresize = resize; resize();

function triggerVisual(x, y, type, freq, style) {
    // Type: pulse (drum), drum (timbale), guitar
    if(type === 'pulse') {
        // Background Thump
        particles.push({type: 'shockwave', r: 10, maxR: w/1.5, x: w/2, y: h/2, color: '#220000', alpha: 1});
    }
    else if(type === 'drum') {
        // Pop left or right
        particles.push({type: 'spark', x: w/2 + x, y: h/2 + (Math.random()*200-100), r: 5, color: '#ffcc00'});
    }
    else if (type === 'guitar') {
        // Generate a "string line" vibration or Fire
        const color = style === 'hold' ? '#ff0000' : '#ff9900'; // Red for hold, Orange for run
        const size = style === 'hold' ? 150 : 50;
        
        particles.push({
            type: 'orb', 
            x: w/2 + (Math.random()*400-200), 
            y: h/2 + (Math.random()*400-200),
            r: 1, targetR: style==='hold' ? 80 : 20,
            color: color,
            decay: style==='hold' ? 0.005 : 0.05
        });
    }
}

function render() {
    // Fade Trail
    c.fillStyle = 'rgba(10, 5, 5, 0.2)';
    c.fillRect(0, 0, w, h);
    c.globalCompositeOperation = 'lighter'; // Fire blending mode

    for(let i=particles.length-1; i>=0; i--) {
        let p = particles[i];
        
        if(p.type === 'shockwave') {
            p.r += 15;
            p.alpha -= 0.02;
            c.beginPath();
            c.strokeStyle = `rgba(255, 50, 0, ${p.alpha})`;
            c.lineWidth = 5;
            c.arc(p.x, p.y, p.r, 0, Math.PI*2);
            c.stroke();
            if(p.alpha <= 0) particles.splice(i, 1);
        } 
        else if(p.type === 'spark') {
            c.fillStyle = p.color;
            c.beginPath();
            c.arc(p.x, p.y, p.r, 0, Math.PI*2);
            c.fill();
            p.r *= 0.9; // shrink
            if(p.r < 0.5) particles.splice(i,1);
        }
        else if(p.type === 'orb') {
            p.r += (p.targetR - p.r) * 0.1; // Ease in size
            c.beginPath();
            const grad = c.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.r);
            grad.addColorStop(0, 'white');
            grad.addColorStop(0.3, p.color);
            grad.addColorStop(1, 'transparent');
            c.fillStyle = grad;
            c.arc(p.x, p.y, p.r, 0, Math.PI*2);
            c.fill();
            
            p.targetR -= 0.5; // Shrink over time
            if(p.targetR <= 0) particles.splice(i,1);
        }
    }
    c.globalCompositeOperation = 'source-over';
    
    if(isPlaying) requestAnimationFrame(render);
}

/* ------------------------------------------------------------
   INITIALIZATION
   ------------------------------------------------------------ */
document.getElementById('start').addEventListener('click', (e) => {
    e.target.style.display = 'none';
    document.querySelector('h1').innerText = "LIVE SESSION IN E PHRYGIAN";
    document.getElementById('overlay').style.opacity = 0;
    setTimeout(() => document.getElementById('overlay').style.pointerEvents = 'none', 1000);
    
    setupRig();
    if(ctx.state === 'suspended') ctx.resume();
    
    isPlaying = true;
    startGroove(); // Start Drums
    setTimeout(guitaristThinking, 1000); // Start Guitar a bit later
    render();
});

</script>
</body>
</html>