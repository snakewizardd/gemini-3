<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JANA GANA MANA // ANTHEM ENGINE</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Rozha+One&family=Courier+New:wght@700&display=swap');

    :root {
        --saffron: #FF9933;
        --white: #FFFFFF;
        --green: #138808;
        --chakra: #000080; /* Navy Blue */
        --bg: #fdfcf0; /* Cream/Paper */
    }

    body {
        margin: 0;
        background: var(--bg);
        overflow: hidden;
        font-family: 'Rozha One', serif;
        color: var(--chakra);
        user-select: none;
    }

    #canvas {
        display: block;
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        z-index: 1;
    }

    #overlay {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: rgba(253, 252, 240, 0.95);
        z-index: 10;
        transition: opacity 0.8s;
    }

    h1 {
        font-size: 4rem;
        margin: 0;
        background: linear-gradient(to bottom, var(--saffron), var(--green));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
        line-height: 1.2;
    }

    p {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        margin-top: 20px;
        font-size: 1.2rem;
        color: var(--chakra);
    }

    .hidden {
        opacity: 0;
        pointer-events: none;
    }

    #hud {
        position: absolute;
        bottom: 30px;
        left: 30px;
        font-family: 'Courier New', monospace;
        font-size: 16px;
        pointer-events: none;
        z-index: 5;
        color: var(--chakra);
        border-left: 4px solid var(--saffron);
        padding-left: 15px;
    }
    
    .chakra-wheel {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 300px; height: 300px;
        border: 2px solid var(--chakra);
        border-radius: 50%;
        opacity: 0.05;
        z-index: 0;
    }
    .spoke {
        position: absolute;
        top: 50%; left: 50%;
        width: 100%; height: 2px;
        background: var(--chakra);
        transform-origin: 0 0;
    }
</style>
</head>
<body>

<div id="overlay">
    <h1>JANA GANA MANA</h1>
    <p>[ CLICK TO BEGIN ]</p>
    <p style="font-size: 0.8rem; color: #888; margin-top: 2rem;">MOUSE Y = REVERB // SPACE = PAUSE</p>
</div>

<div id="hud">
    TONE: NYLON STRING<br>
    BPM: 52 (Anthem)
</div>

<div class="chakra-wheel" id="wheel">
    <!-- JS will populate spokes -->
</div>

<canvas id="canvas"></canvas>

<script>
/**
 * JANA GANA MANA ENGINE
 * Nylon Guitar Physics + Anthem Tab
 */

// Populate Chakra
const wheel = document.getElementById('wheel');
for(let i=0; i<24; i++) {
    const spoke = document.createElement('div');
    spoke.className = 'spoke';
    spoke.style.transform = `rotate(${i * 15}deg)`;
    wheel.appendChild(spoke);
}

// --- CONFIGURATION ---
const CONFIG = {
    BPM: 52, 
    STRINGS: [64, 59, 55, 50, 45, 40], 
    BASE_FREQS: [329.63, 246.94, 196.00, 146.83, 110.00, 82.41], 
    STRING_NAMES: ['e', 'B', 'G', 'D', 'A', 'E']
};

// --- AUDIO ENGINE ---
const AudioEngine = {
    ctx: null,
    master: null,
    reverb: null,
    reverbGain: null,
    isPlaying: false,

    init: async () => {
        const AC = window.AudioContext || window.webkitAudioContext;
        AudioEngine.ctx = new AC();
        
        AudioEngine.master = AudioEngine.ctx.createGain();
        AudioEngine.master.gain.value = 0.6; 

        // Cathedral Reverb
        AudioEngine.reverb = AudioEngine.ctx.createConvolver();
        AudioEngine.reverb.buffer = await AudioEngine.createImpulse(3.0, 3.0); 
        
        AudioEngine.reverbGain = AudioEngine.ctx.createGain();
        AudioEngine.reverbGain.gain.value = 0.4;

        AudioEngine.master.connect(AudioEngine.ctx.destination);
        AudioEngine.master.connect(AudioEngine.reverbGain);
        AudioEngine.reverbGain.connect(AudioEngine.reverb);
        AudioEngine.reverb.connect(AudioEngine.ctx.destination);
    },

    createImpulse: async (duration, decay) => {
        const rate = AudioEngine.ctx.sampleRate;
        const length = rate * duration;
        const impulse = AudioEngine.ctx.createBuffer(2, length, rate);
        const L = impulse.getChannelData(0);
        const R = impulse.getChannelData(1);
        for (let i = 0; i < length; i++) {
            L[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, decay);
            R[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, decay);
        }
        return impulse;
    },

    // Nylon String Tone
    playString: (stringIdx, fret, time, duration = 2.0, slideTo = null) => {
        if (!AudioEngine.ctx) return;
        
        const t = time;
        const baseFreq = CONFIG.BASE_FREQS[stringIdx];
        const freq = baseFreq * Math.pow(2, fret / 12);
        
        const osc1 = AudioEngine.ctx.createOscillator();
        const osc2 = AudioEngine.ctx.createOscillator();
        
        // Nylon: Sine dominant with subtle Triangle
        osc1.type = 'sine'; 
        osc2.type = 'triangle'; 
        
        let targetFreq = freq;
        if (slideTo !== null) {
            targetFreq = baseFreq * Math.pow(2, slideTo / 12);
            osc1.frequency.setValueAtTime(freq, t);
            osc1.frequency.linearRampToValueAtTime(targetFreq, t + 0.2);
            osc2.frequency.setValueAtTime(freq, t);
            osc2.frequency.linearRampToValueAtTime(targetFreq, t + 0.2);
        } else {
            osc1.frequency.value = freq;
            osc2.frequency.value = freq;
        }

        // Filter: Warm pluck
        const filter = AudioEngine.ctx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.setValueAtTime(2000, t);
        filter.frequency.exponentialRampToValueAtTime(800, t + 0.1); 
        filter.Q.value = 0;

        const amp = AudioEngine.ctx.createGain();
        amp.gain.setValueAtTime(0, t);
        amp.gain.linearRampToValueAtTime(0.6, t + 0.02); // Finger pluck attack
        amp.gain.exponentialRampToValueAtTime(0.001, t + duration); 

        // Mix
        const osc1Gain = AudioEngine.ctx.createGain(); osc1Gain.gain.value = 0.7;
        const osc2Gain = AudioEngine.ctx.createGain(); osc2Gain.gain.value = 0.3;

        osc1.connect(osc1Gain); osc1Gain.connect(filter);
        osc2.connect(osc2Gain); osc2Gain.connect(filter);
        filter.connect(amp);
        amp.connect(AudioEngine.master);

        osc1.start(t); osc1.stop(t + duration);
        osc2.start(t); osc2.stop(t + duration);
    },

    setReverb: (val) => {
        if(AudioEngine.reverbGain) {
            AudioEngine.reverbGain.gain.setTargetAtTime(val, AudioEngine.ctx.currentTime, 0.1);
        }
    }
};

// --- TAB DATA PARSER ---
const TAB = [];
function addNote(beat, string, fret, type = 'pluck', target = null) {
    TAB.push({ beat, string, fret, type, target });
}
function addChord(beat, notes) {
    notes.forEach(n => addNote(beat, n[0], n[1]));
}

// -- BUILD THE SONG --
let b = 0.0;
const Q = 1.0; // Quarter note (The beat)
const E = 0.5; // Eighth note

// === JANA GANA MANA ===
// Key: C Major (Tab is in C relative to open strings/frets shown)
// Timing: 4/4 roughly, but lyrical phrasing is key.

// Phrase 1: "Jana Gana Mana Adhinayaka Jaya He"
// e---0-2-2-2---2-2-2---2-2-0-2-3---2---2-2-0---0-0---0
// B-3
// D-0
// A-4 2 0 0
// E 3

// e-0 (beat 1)
addNote(b, 0, 0); addNote(b, 1, 3); addNote(b, 3, 0); b+=Q;
// e-2 2 2 (Jana Gana)
addNote(b, 0, 2); b+=Q;
addNote(b, 0, 2); b+=Q;
addNote(b, 0, 2); b+=Q;

// e-2 2 2 (Mana Adhi)
addNote(b, 0, 2); addNote(b, 4, 4); b+=Q; // Bass C# (A-4)
addNote(b, 0, 2); b+=Q;
addNote(b, 0, 2); b+=Q;

// e-2 2 0 2 3 (Nayaka)
addNote(b, 0, 2); addNote(b, 4, 2); b+=Q; // Bass B
addNote(b, 0, 2); b+=E;
addNote(b, 0, 0); b+=E;
addNote(b, 0, 2); b+=E;
addNote(b, 0, 3); b+=E;

// e-2 (Jaya)
addNote(b, 0, 2); addNote(b, 5, 3); b+=Q; // Bass G
addNote(b, 0, 2); b+=E;
addNote(b, 0, 2); b+=E;

// e-0 0 0 0 (He)
addNote(b, 0, 0); addNote(b, 4, 0); b+=Q; // Bass A
addNote(b, 0, 0); b+=E;
addNote(b, 0, 0); b+=E;
addNote(b, 0, 0); addNote(b, 4, 0); b+=Q; 

// Phrase 2: "Bharata Bhagya Vidhata"
// e-5 5 5 5 5 4 5 5 5 4 7 5 3 3 3 3 3 2 0 3 2
// B-3 3 3 3
// G-0 3
// D-5 0
// A-5 4 2 0 0
// E 3

// e-5 5 5 5 (Bharata)
addNote(b, 0, 5); addNote(b, 1, 3); addNote(b, 4, 5); b+=Q; // Bass D
addNote(b, 0, 5); b+=Q;
addNote(b, 0, 5); b+=Q;
addNote(b, 0, 5); b+=Q;

// e-5 4 5 (Bhagya)
addNote(b, 0, 5); addNote(b, 1, 3); addNote(b, 4, 4); b+=Q; // Bass C#
addNote(b, 0, 4); b+=E;
addNote(b, 0, 5); b+=Q; // Hold?

// e-5 5 4 7 5 (Vidhata)
addNote(b, 0, 5); addNote(b, 1, 3); addNote(b, 4, 2); b+=Q; // Bass B
addNote(b, 0, 5); b+=E;
addNote(b, 0, 4); b+=E;
addNote(b, 0, 7); b+=E;
addNote(b, 0, 5); b+=E;

// e-3 3 3 3 (Punjab Sindhu)
// G-0
// E-3
addNote(b, 0, 3); addNote(b, 1, 3); addNote(b, 2, 0); addNote(b, 5, 3); b+=Q;
addNote(b, 0, 3); b+=Q;
addNote(b, 0, 3); b+=Q;
addNote(b, 0, 3); b+=Q;

// e-3 2 0 3 2 (Gujarata Maratha)
// G-3
// D-5
// A-0
addNote(b, 0, 3); addNote(b, 1, 3); addNote(b, 2, 3); addNote(b, 3, 5); b+=Q;
addNote(b, 0, 2); b+=E;
addNote(b, 0, 0); b+=E;
addNote(b, 0, 3); b+=E;
addNote(b, 0, 2); addNote(b, 1, 3); addNote(b, 3, 0); b+=Q; // D Bass

b+=1.0; // Breath

// Phrase 3: "Dravida Utkala Banga"
// e-2 2 2 2 2 0 5 5 5 3 3 2 2 2 0 0 0 0 0
// B-3 1 3 3 3 3 3 3 2 2 3
// G-2 2 0 2 2
// D-0 0 2 0 0
// A 3 0 0
// E 3 3

// e-2 2 2 2 (Dravida)
addNote(b, 0, 2); addNote(b, 1, 3); addNote(b, 2, 2); addNote(b, 3, 0); b+=Q;
addNote(b, 0, 2); b+=Q;
addNote(b, 0, 2); b+=Q;
addNote(b, 0, 2); b+=Q;

// e-2 0 5 5 5 (Utkala)
addNote(b, 0, 2); addNote(b, 1, 1); addNote(b, 2, 2); addNote(b, 3, 0); b+=Q;
addNote(b, 0, 0); b+=E;
addNote(b, 0, 5); addNote(b, 1, 3); addNote(b, 5, 3); b+=Q;
addNote(b, 0, 5); b+=E;
addNote(b, 0, 5); b+=E;

// e-3 3 2 2 2 (Banga)
addNote(b, 0, 3); addNote(b, 1, 3); addNote(b, 2, 0); addNote(b, 3, 2); addNote(b, 4, 3); b+=Q; // C chord
addNote(b, 0, 3); b+=E; // Tab shows 3-3 split?
// "3 3 2"
addNote(b, 0, 3); b+=Q;
addNote(b, 0, 2); addNote(b, 1, 3); addNote(b, 2, 2); addNote(b, 3, 0); b+=Q; // D
addNote(b, 0, 2); b+=E;
addNote(b, 0, 2); b+=E;

// e-0 0 0 0 0 (Vindhya...)
addNote(b, 0, 0); addNote(b, 1, 2); addNote(b, 2, 2); addNote(b, 4, 0); b+=Q;
addNote(b, 0, 0); b+=E;
addNote(b, 0, 0); b+=E;
addNote(b, 0, 0); b+=Q;
addNote(b, 0, 0); addNote(b, 1, 3); addNote(b, 3, 0); b+=Q; // End phrase

b+=1.0;

// Phrase 4: "Jaya He, Jaya He, Jaya He"
// e-2 2 2 2 2 2 2 2 0 2 3
// B-3 1 3 3
// G-2 2 0 0
// D-0 0
// A 3
// E 3

// e-2 (repeated)
addNote(b, 0, 2); addNote(b, 1, 3); addNote(b, 2, 2); addNote(b, 3, 0); b+=Q;
for(let i=0; i<7; i++) {
    addNote(b, 0, 2); b+=E;
}

// e-0 2 3
addNote(b, 0, 0); addNote(b, 1, 1); addNote(b, 2, 2); addNote(b, 3, 0); b+=Q;
addNote(b, 0, 2); b+=E;
addNote(b, 0, 3); addNote(b, 1, 3); addNote(b, 2, 0); addNote(b, 4, 3); addNote(b, 5, 3); b+=Q*2; // G/C

// Phrase 5: "Jaya Jaya Jaya Jaya He"
// e-2 3 5 5 5 3 2 0 3 2
// B-3 2 3 3
// G-2 2
// D-0 0
// A 4 1
// E

// e-2 3 5 (Jaya)
addNote(b, 0, 2); addNote(b, 1, 3); addNote(b, 2, 2); addNote(b, 3, 0); b+=Q;
addNote(b, 0, 3); b+=E;
addNote(b, 0, 5); addNote(b, 4, 4); b+=Q; // C#dim?

// e-5 5 3 (Jaya)
addNote(b, 0, 5); b+=E;
addNote(b, 0, 5); b+=E;
addNote(b, 0, 3); addNote(b, 1, 2); addNote(b, 4, 1); b+=Q; // Bb?

// e-2 0 3 2 (Jaya He)
addNote(b, 0, 2); b+=E;
addNote(b, 0, 0); b+=E;
addNote(b, 0, 3); addNote(b, 1, 3); addNote(b, 2, 2); addNote(b, 3, 0); b+=Q;
addNote(b, 0, 2); addNote(b, 1, 3); b+=Q*2;

// Ending
// e-2 2 2 0 0 0 0 0
// B-3 2 2 3
// G-2 2
// D-0 0
// A 0 0
// E

addNote(b, 0, 2); addNote(b, 1, 3); addNote(b, 2, 2); addNote(b, 3, 0); b+=Q;
addNote(b, 0, 2); b+=E;
addNote(b, 0, 2); b+=E;

addNote(b, 0, 0); addNote(b, 1, 2); addNote(b, 2, 2); addNote(b, 4, 0); b+=Q;
addNote(b, 0, 0); b+=E;
addNote(b, 0, 0); b+=E;
addNote(b, 0, 0); b+=Q;
addNote(b, 0, 0); addNote(b, 1, 3); addNote(b, 3, 0); b+=Q*3; // Final Chord

const LOOP_LENGTH = b;

// --- SEQUENCER ---
let currentBeat = -1.0; 
let startTime = 0;
let nextNoteIdx = 0;

function scheduler() {
    if (!AudioEngine.isPlaying) return;

    const currentTime = AudioEngine.ctx.currentTime;
    const elapsed = currentTime - startTime;
    currentBeat = (elapsed * (CONFIG.BPM / 60)); 

    if (currentBeat >= LOOP_LENGTH) {
        startTime = currentTime;
        currentBeat = 0;
        nextNoteIdx = 0; 
    }

    while (nextNoteIdx < TAB.length) {
        const note = TAB[nextNoteIdx];
        if (note.beat <= currentBeat + 0.1) {
            const playTime = startTime + (note.beat * (60 / CONFIG.BPM));
            AudioEngine.playString(note.string, note.fret, playTime, 2.0, note.target);
            triggerVisual(note);
            nextNoteIdx++;
        } else {
            break;
        }
    }
    requestAnimationFrame(scheduler);
}

// --- VISUAL ENGINE ---
const cvs = document.getElementById('canvas');
const ctx = cvs.getContext('2d');
let w, h;
const activeNotes = [];

function resize() {
    w = cvs.width = window.innerWidth;
    h = cvs.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

function triggerVisual(note) {
    activeNotes.push({
        ...note,
        x: w * 0.2, 
        life: 1.0,
        born: Date.now()
    });
}

function draw() {
    ctx.clearRect(0, 0, w, h);

    const STAFF_Y = h / 2;
    const SPACING = 30; 
    const HIT_X = w * 0.2; 

    // Staff
    ctx.lineWidth = 1;
    ctx.strokeStyle = '#000080';
    ctx.font = "16px 'Courier New'";
    ctx.fillStyle = '#138808';
    
    CONFIG.STRING_NAMES.forEach((name, i) => {
        const y = STAFF_Y + (i * SPACING) - (2.5 * SPACING);
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(w, y);
        ctx.stroke();
        ctx.fillText(name, 10, y + 5);
    });

    // Hit Line
    ctx.beginPath();
    ctx.moveTo(HIT_X, STAFF_Y - 100);
    ctx.lineTo(HIT_X, STAFF_Y + 100);
    ctx.strokeStyle = '#FF9933';
    ctx.lineWidth = 3;
    ctx.stroke();

    // Notes
    const pixelsPerBeat = 80; 
    
    ctx.font = "20px 'Rozha One'";
    TAB.forEach(note => {
        let noteBeat = note.beat;
        let dist = noteBeat - currentBeat;
        if (dist < -2) dist += LOOP_LENGTH; 

        const x = HIT_X + (dist * pixelsPerBeat);
        
        if (x > 0 && x < w) {
            const y = STAFF_Y + (note.string * SPACING) - (2.5 * SPACING);
            
            ctx.fillStyle = '#FF9933'; // Saffron
            let txt = note.fret;
            if(note.target) txt += '/';
            
            ctx.beginPath();
            ctx.arc(x, y - 5, 14, 0, Math.PI*2);
            ctx.fillStyle = '#000080'; // Navy
            ctx.fill();
            ctx.strokeStyle = '#138808'; // Green
            ctx.lineWidth = 2;
            ctx.stroke();
            
            ctx.fillStyle = '#fff'; 
            ctx.fillText(txt, x - 6, y + 6);
        }
    });

    // Ripples
    for (let i = activeNotes.length - 1; i >= 0; i--) {
        const n = activeNotes[i];
        const y = STAFF_Y + (n.string * SPACING) - (2.5 * SPACING);
        
        const radius = 15 + ((1 - n.life) * 60);
        ctx.beginPath();
        ctx.arc(HIT_X, y - 5, radius, 0, Math.PI*2);
        ctx.strokeStyle = `rgba(255, 153, 51, ${n.life})`;
        ctx.lineWidth = 3;
        ctx.stroke();

        n.life -= 0.01; // Slow fade for reverence
        if(n.life <= 0) activeNotes.splice(i, 1);
    }

    requestAnimationFrame(draw);
}

// --- INPUTS ---
document.addEventListener('keydown', (e) => {
    if (e.code === 'Space') togglePlay();
});

document.addEventListener('click', () => {
    if(!AudioEngine.ctx) {
        AudioEngine.init();
        togglePlay();
    }
});

document.addEventListener('mousemove', (e) => {
    if (!AudioEngine.ctx) return;
    const y = e.clientY / window.innerHeight;
    AudioEngine.setReverb(y);
});

function togglePlay() {
    if (AudioEngine.isPlaying) {
        AudioEngine.isPlaying = false;
        document.getElementById('overlay').classList.remove('hidden');
    } else {
        AudioEngine.isPlaying = true;
        document.getElementById('overlay').classList.add('hidden');
        if (startTime === 0) startTime = AudioEngine.ctx.currentTime;
        startTime = AudioEngine.ctx.currentTime - (currentBeat * (60/CONFIG.BPM));
        scheduler();
    }
}

draw(); 

</script>
</body>
</html>