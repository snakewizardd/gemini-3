<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEMINI // FUNK // AGENT</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,900;1,900&family=Roboto+Mono:wght@400;700&display=swap');

        :root {
            --neon-pink: #ff0055;
            --neon-blue: #00d9ff;
            --neon-purp: #9d00ff;
            --dark: #0a0a0c;
            --grid: rgba(255,255,255,0.05);
        }

        body {
            margin: 0;
            background-color: var(--dark);
            color: white;
            font-family: 'Roboto Mono', monospace;
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* BACKGROUND GRID ANIMATION */
        #grid-plane {
            position: absolute;
            top: 50%; left: 50%;
            width: 200vw; height: 200vh;
            transform: translate(-50%, -50%) perspective(500px) rotateX(60deg);
            background-image: 
                linear-gradient(var(--grid) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid) 1px, transparent 1px);
            background-size: 100px 100px;
            background-position: 0 0;
            z-index: 0;
            animation: gridMove 2s linear infinite;
        }

        @keyframes gridMove {
            from { background-position: 0 0; }
            to { background-position: 0 100px; }
        }

        #ui-layer {
            z-index: 10;
            position: relative;
            text-align: center;
            width: 100%;
            pointer-events: none;
        }

        h1 {
            font-family: 'Montserrat', sans-serif;
            font-style: italic;
            font-size: 5rem;
            line-height: 0.8;
            text-transform: uppercase;
            margin: 0;
            text-shadow: 0 0 20px var(--neon-purp);
            transform: skewY(-5deg);
        }

        .gradient-text {
            background: linear-gradient(to right, var(--neon-blue), var(--neon-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #spectrum {
            width: 600px;
            height: 200px;
            margin: 20px auto;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 4px;
            opacity: 0.8;
        }

        .bar {
            width: 10px;
            background: var(--neon-pink);
            box-shadow: 0 0 10px var(--neon-pink);
            transition: height 0.05s ease;
            border-top-right-radius: 5px;
            border-top-left-radius: 5px;
        }

        #status {
            font-size: 0.8rem;
            color: #666;
            margin-top: 20px;
            letter-spacing: 4px;
        }

        /* INTERACTIVE BUTTON */
        #play-btn {
            pointer-events: auto;
            background: transparent;
            border: 2px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 20px 50px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-style: italic;
            font-size: 1.5rem;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 0 15px var(--neon-blue), inset 0 0 15px var(--neon-blue);
            transition: all 0.3s ease;
            margin-top: 30px;
        }

        #play-btn:hover {
            background: var(--neon-blue);
            color: var(--dark);
            box-shadow: 0 0 50px var(--neon-blue);
            transform: scale(1.1);
        }

        .hidden { display: none; }

        /* BPM FLASHER */
        .beat-flash {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(255,0,85,0.2) 0%, rgba(0,0,0,0) 70%);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.1s;
        }
    </style>
</head>
<body>

    <div id="grid-plane"></div>
    <div class="beat-flash" id="flash"></div>

    <div id="ui-layer">
        <h1>GEMINI<br><span class="gradient-text">FUNK ENGINE</span></h1>
        
        <div id="spectrum">
            <!-- Bars generated by JS -->
        </div>

        <div id="status">AWAITING HUMAN INPUT // INITIALIZING DSP CHAIN</div>
        <button id="play-btn">INITIATE GROOVE</button>
    </div>

<script>
/**
 * GEMINI AGI AUDIO ENGINE v3.0
 * PROCEDURAL FUNK GENERATION
 * 
 * Key Features:
 * 1. FM Synthesis Bass (The "Slap" sound)
 * 2. Gated Reverb Snares (The "80s" sound)
 * 3. Swing Logic (Humanization algorithm)
 * 4. Sidechain Compression Simulation
 */

// --- CONFIG ---
const BPM = 114; 
const SWING_RATIO = 0.20; // Heavy swing
const LOOKAHEAD = 25.0; 
const SCHEDULE_AHEAD = 0.1;
const MASTER_VOL = 0.8;

// --- SCALES & THEORY ---
// E Minor Dorian mode for that Daft Punk feel
const SCALE = {
    root: 40, // E2
    notes: [0, 2, 3, 5, 7, 9, 10, 12, 14, 15], // Intervals
    chordMap: [
        [0, 3, 7, 10], // Em7
        [5, 9, 12, 15], // Am7
        [7, 11, 14, 17], // Bm7
        [3, 7, 10, 14]  // Gmaj7
    ]
};

let audioCtx;
let nextNoteTime = 0.0;
let current16th = 0;
let currentBar = 0;
let isPlaying = false;
let analyser;
let reverbBuffer;
let noiseBuffer;
let compressor;

// --- INITIALIZATION ---

async function init() {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AudioContext();
    
    // Master Compressor (The "Glue")
    compressor = audioCtx.createDynamicsCompressor();
    compressor.threshold.value = -20;
    compressor.knee.value = 30;
    compressor.ratio.value = 12;
    compressor.attack.value = 0.003;
    compressor.release.value = 0.25;
    compressor.connect(audioCtx.destination);

    // Generate Impulse Responses & Noise once
    reverbBuffer = await createImpulseResponse();
    noiseBuffer = createNoiseBuffer();

    // Analyser for visuals
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 64;
    compressor.connect(analyser);

    document.getElementById('play-btn').classList.add('hidden');
    document.getElementById('status').innerText = "GENERATING REAL-TIME FUNK // SYNC: 100%";
    
    isPlaying = true;
    nextNoteTime = audioCtx.currentTime + 0.1;
    requestAnimationFrame(scheduler);
    requestAnimationFrame(drawVisuals);
}

// --- DSP UTILS ---

function mtof(note) {
    return 440 * Math.pow(2, (note - 69) / 12);
}

function createNoiseBuffer() {
    const bufferSize = audioCtx.sampleRate * 2; 
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const output = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) {
        output[i] = Math.random() * 2 - 1;
    }
    return buffer;
}

async function createImpulseResponse() {
    // Synthesize a "Plate Reverb" sound
    const length = audioCtx.sampleRate * 1.5;
    const impulse = audioCtx.createBuffer(2, length, audioCtx.sampleRate);
    for (let channel = 0; channel < 2; channel++) {
        const data = impulse.getChannelData(channel);
        for (let i = 0; i < length; i++) {
            const decay = Math.pow(1 - i / length, 3);
            data[i] = (Math.random() * 2 - 1) * decay;
        }
    }
    return impulse;
}

// --- INSTRUMENTS ---

// 1. THE FUNK BASS (FM Synthesis)
// Uses a modulator oscillator to change the frequency of the carrier oscillator
// creating that rich, squelchy distinctive sound.
function playBass(time, note, duration, slide = false) {
    const osc = audioCtx.createOscillator();
    const mod = audioCtx.createOscillator();
    const modGain = audioCtx.createGain();
    const filter = audioCtx.createBiquadFilter();
    const amp = audioCtx.createGain();

    const freq = mtof(note);
    
    // Carrier
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(freq, time);
    if(slide) osc.frequency.exponentialRampToValueAtTime(mtof(note+12), time + duration);

    // Modulator (FM) - Adds the metallic growl
    mod.type = 'sine';
    mod.frequency.value = freq * 2; 
    modGain.gain.setValueAtTime(freq * 1.5, time);
    modGain.gain.exponentialRampToValueAtTime(1, time + 0.2);
    
    // Filter Envelope (The "Wub")
    filter.type = 'lowpass';
    filter.Q.value = 6; // High resonance
    filter.frequency.setValueAtTime(200, time);
    filter.frequency.exponentialRampToValueAtTime(3000, time + 0.05); // Attack
    filter.frequency.exponentialRampToValueAtTime(100, time + duration); // Decay

    // Amp Envelope
    amp.gain.setValueAtTime(0.8, time);
    amp.gain.exponentialRampToValueAtTime(0.01, time + duration);

    // Routing
    mod.connect(modGain);
    modGain.connect(osc.frequency);
    osc.connect(filter);
    filter.connect(amp);
    amp.connect(compressor);

    osc.start(time);
    mod.start(time);
    osc.stop(time + duration + 0.1);
    mod.stop(time + duration + 0.1);
}

// 2. DRUMS
function playKick(time) {
    const osc = audioCtx.createOscillator();
    const amp = audioCtx.createGain();
    
    // Pitch drop for punch
    osc.frequency.setValueAtTime(180, time);
    osc.frequency.exponentialRampToValueAtTime(40, time + 0.15);
    
    amp.gain.setValueAtTime(1, time);
    amp.gain.exponentialRampToValueAtTime(0.001, time + 0.4);

    osc.connect(amp);
    amp.connect(compressor);
    osc.start(time);
    osc.stop(time + 0.4);

    // Visual Flash
    const flash = document.getElementById('flash');
    flash.style.opacity = 0.3;
    setTimeout(() => flash.style.opacity = 0, 50);
}

function playSnare(time) {
    // 1. Tonal "Thwack"
    const osc = audioCtx.createOscillator();
    const oscAmp = audioCtx.createGain();
    osc.frequency.setValueAtTime(250, time);
    osc.frequency.exponentialRampToValueAtTime(150, time + 0.1);
    oscAmp.gain.setValueAtTime(0.5, time);
    oscAmp.gain.exponentialRampToValueAtTime(0.001, time + 0.15);
    osc.connect(oscAmp);
    oscAmp.connect(compressor);
    osc.start(time); osc.stop(time + 0.2);

    // 2. Noise "Sizzle"
    const noiseSource = audioCtx.createBufferSource();
    noiseSource.buffer = noiseBuffer;
    const noiseFilter = audioCtx.createBiquadFilter();
    noiseFilter.type = 'highpass';
    noiseFilter.frequency.value = 2000;
    const noiseAmp = audioCtx.createGain();
    noiseAmp.gain.setValueAtTime(0.8, time);
    noiseAmp.gain.exponentialRampToValueAtTime(0.001, time + 0.2);
    
    noiseSource.connect(noiseFilter);
    noiseFilter.connect(noiseAmp);
    noiseAmp.connect(compressor);

    // 3. Reverb Send (Gated)
    const revConvolver = audioCtx.createConvolver();
    revConvolver.buffer = reverbBuffer;
    const revGain = audioCtx.createGain();
    revGain.gain.value = 0.5;
    noiseAmp.connect(revConvolver);
    revConvolver.connect(revGain);
    revGain.connect(compressor);

    noiseSource.start(time);
    noiseSource.stop(time + 0.3);
}

function playHiHat(time, open = false) {
    const source = audioCtx.createBufferSource();
    source.buffer = noiseBuffer;
    const filter = audioCtx.createBiquadFilter();
    filter.type = 'highpass';
    filter.frequency.value = 8000; // Very high crisp freq
    
    const amp = audioCtx.createGain();
    // Velocity variation
    const velocity = 0.3 + Math.random() * 0.2;
    
    amp.gain.setValueAtTime(velocity, time);
    amp.gain.exponentialRampToValueAtTime(0.001, time + (open ? 0.3 : 0.05));

    source.connect(filter);
    filter.connect(amp);
    // Pan slightly right
    const panner = audioCtx.createStereoPanner();
    panner.pan.value = 0.2;
    amp.connect(panner);
    panner.connect(compressor);

    source.start(time);
    source.stop(time + 0.4);
}

// 3. POLYPHONIC SYNTH (Super-Saw Chords)
function playChord(time, chordNotes) {
    const gainNode = audioCtx.createGain();
    // Sidechain Ducking: When kick hits, chords dip volume
    gainNode.gain.setValueAtTime(0, time); 
    gainNode.gain.linearRampToValueAtTime(0.3, time + 0.05);
    gainNode.gain.exponentialRampToValueAtTime(0.001, time + 1.0);

    const filter = audioCtx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.value = 1500;
    filter.Q.value = 1;

    gainNode.connect(filter);
    filter.connect(compressor);

    chordNotes.forEach((interval, i) => {
        // Create 2 oscillators per note for detuned thick sound
        [0, 5].forEach(detune => {
            const osc = audioCtx.createOscillator();
            osc.type = 'sawtooth';
            osc.frequency.value = mtof(SCALE.root + interval + 12); // Octave up
            osc.detune.value = (Math.random() * 10) - 5; // Analog drift
            osc.connect(gainNode);
            osc.start(time);
            osc.stop(time + 1.0);
        });
    });
}

// 4. FUNK GUITAR (Pluck)
function playPluck(time, note) {
    const osc = audioCtx.createOscillator();
    osc.type = 'square'; // Hollow sound
    const filter = audioCtx.createBiquadFilter();
    filter.type = 'bandpass';
    filter.Q.value = 4;
    filter.frequency.setValueAtTime(800, time);
    filter.frequency.exponentialRampToValueAtTime(3000, time + 0.1); // Wah effect

    const amp = audioCtx.createGain();
    amp.gain.setValueAtTime(0.15, time);
    amp.gain.exponentialRampToValueAtTime(0.001, time + 0.15);

    osc.frequency.value = mtof(note + 24); // High register
    osc.connect(filter);
    filter.connect(amp);
    
    const panner = audioCtx.createStereoPanner();
    panner.pan.value = -0.4; // Left
    amp.connect(panner);
    panner.connect(compressor);

    osc.start(time);
    osc.stop(time + 0.2);
}

// --- SCHEDULER ---

function scheduler() {
    while (nextNoteTime < audioCtx.currentTime + SCHEDULE_AHEAD) {
        scheduleNote(current16th, nextNoteTime);
        next();
    }
    if(isPlaying) requestAnimationFrame(scheduler);
}

function next() {
    const secondsPerBeat = 60.0 / BPM;
    const quarterTime = secondsPerBeat;
    // Calculate 16th note time
    // Add Swing: Delays even 16th notes
    let time = quarterTime / 4;
    
    nextNoteTime += time;
    current16th++;
    if (current16th === 16) {
        current16th = 0;
        currentBar++;
    }
}

function scheduleNote(beatNumber, time) {
    // SWING LOGIC
    let playTime = time;
    if (beatNumber % 2 !== 0) {
        playTime += (60/BPM/4) * SWING_RATIO;
    }

    // --- THE GROOVE ALGORITHM ---

    // 1. Drums (Foundation)
    if (beatNumber === 0 || beatNumber === 8) {
        playKick(playTime);
    } else if (beatNumber === 14 && Math.random() > 0.5) {
        playKick(playTime); // Syncopated kick
    }

    if (beatNumber === 4 || beatNumber === 12) {
        playSnare(playTime);
    }

    // Hi-Hats: 16th note pattern with accents
    if (beatNumber % 4 === 2) {
        playHiHat(playTime, true); // Open hat on off-beat
    } else {
        playHiHat(playTime, false); // Closed hat
    }

    // 2. Bass (The Funk)
    const root = SCALE.root;
    
    // Always hit the One
    if (beatNumber === 0) {
        playBass(playTime, root, 0.4); 
    } 
    // Octave pops
    else if (beatNumber === 2 || beatNumber === 5) {
        playBass(playTime, root + 12, 0.1); 
    }
    // Chromatism/Fill at end of bar
    else if (beatNumber === 15) {
        playBass(playTime, root + 10, 0.1, true);
    }
    // Ghost notes
    else if (Math.random() > 0.7 && beatNumber % 2 !== 0) {
        playBass(playTime, root, 0.05); // Dead note
    }

    // 3. Chords (The Vibe)
    if (beatNumber === 0 && currentBar % 2 === 0) {
        // Chord progression loop
        const chordIdx = Math.floor(currentBar / 2) % 4;
        playChord(playTime, SCALE.chordMap[chordIdx]);
    }

    // 4. Guitar Plucks (The Candy)
    if ([3, 6, 9, 13].includes(beatNumber)) {
        if (Math.random() > 0.4) {
            // Pick random note from pentatonic
            const note = SCALE.notes[Math.floor(Math.random()*5)] + SCALE.root;
            playPluck(playTime, note);
        }
    }
}

// --- VISUALIZER ---

const specContainer = document.getElementById('spectrum');
// Create bars
for(let i=0; i<20; i++) {
    const d = document.createElement('div');
    d.className = 'bar';
    specContainer.appendChild(d);
}
const domBars = document.querySelectorAll('.bar');

function drawVisuals() {
    requestAnimationFrame(drawVisuals);
    const freqData = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(freqData);

    // Update bars
    domBars.forEach((bar, i) => {
        // Map low frequencies to the center, highs to the sides? 
        // Let's just do standard left-to-right
        const val = freqData[i + 2]; // Skip ultra-lows
        bar.style.height = (val * 0.8) + 'px';
        // Dynamic color based on intensity
        const hue = 320 - (val * 0.5);
        bar.style.backgroundColor = `hsl(${hue}, 100%, 50%)`;
        bar.style.boxShadow = `0 0 ${val/10}px hsl(${hue}, 100%, 50%)`;
    });
}

// Start
document.getElementById('play-btn').addEventListener('click', init);

</script>
</body>
</html>