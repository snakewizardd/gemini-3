<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABARTH 124 // MONZA FINAL</title>
    <style>
        :root {
            --red: #dc002e;
            --bg: #1a1a1a;
            --ui: #fff;
        }

        body {
            margin: 0;
            background: var(--bg);
            overflow: hidden;
            font-family: 'Arial Black', sans-serif;
            color: var(--ui);
            user-select: none;
        }

        canvas {
            position: absolute;
            top: 0; left: 0;
        }

        /* DASHBOARD */
        #hud {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 300px;
            text-align: right;
            pointer-events: none;
        }

        #tacho-bar {
            width: 100%;
            height: 30px;
            background: #333;
            border: 4px solid #fff;
            transform: skew(-20deg);
            overflow: hidden;
            position: relative;
        }

        #rpm-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ffff00, #ff0000);
            transition: width 0.05s linear;
        }

        #speed-val { font-size: 4rem; line-height: 1; }
        #gear-val { font-size: 2rem; color: var(--red); }

        /* INPUT DEBUGGER */
        #input-debug {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
        }
        .key {
            width: 40px; height: 40px;
            border: 2px solid #555;
            color: #555;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 5px;
            font-size: 12px;
        }
        .key.active {
            border-color: var(--red);
            background: var(--red);
            color: white;
            box-shadow: 0 0 15px var(--red);
        }

        /* START OVERLAY */
        #overlay {
            position: absolute;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        h1 { font-size: 4rem; color: var(--red); text-transform: uppercase; margin: 0; font-style: italic; }
        
        #start-btn {
            margin-top: 20px;
            padding: 20px 50px;
            background: white;
            color: black;
            font-size: 1.5rem;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transform: skew(-10deg);
        }
        #start-btn:hover { background: var(--red); color: white; }

    </style>
</head>
<body>

    <div id="overlay">
        <h1>SCORPION EVO</h1>
        <div style="margin-top: 10px; font-size: 12px; color: #aaa;">WASD or ARROWS to Drive</div>
        <button id="start-btn" onclick="bootSystem()">START ENGINE</button>
    </div>

    <canvas id="world"></canvas>

    <div id="input-debug">
        <div class="key" id="k-w">W</div>
        <div class="key" id="k-a">A</div>
        <div class="key" id="k-s">S</div>
        <div class="key" id="k-d">D</div>
    </div>

    <div id="hud">
        <div><span id="speed-val">0</span> KMH</div>
        <div>GEAR <span id="gear-val">N</span></div>
        <div id="tacho-bar"><div id="rpm-fill"></div></div>
    </div>

    <script>
        /* 
         * 1. CORE CONFIGURATION
         */
        const canvas = document.getElementById('world');
        const ctx = canvas.getContext('2d', { alpha: false });
        
        let width = window.innerWidth;
        let height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;

        // PHYSICS VARS
        const car = {
            x: 0, y: 0,
            angle: 0,          // Facing direction
            speed: 0,          // Forward velocity magnitude
            latSpeed: 0,       // Lateral velocity (Drift)
            rpm: 800,
            gear: 1,
            
            // Specs
            accel: 0.2,
            friction: 0.98,
            turnRate: 0.07,
            maxSpeed: 40,
            grip: 0.94         // High = Sticky, Low = Drifty
        };

        const input = { w: false, s: false, a: false, d: false, space: false };
        let isRunning = false;

        /* 
         * 2. AUDIO ENGINE: THE MONZA
         */
        const AC = window.AudioContext || window.webkitAudioContext;
        let actx, master, limiter;
        
        // Nodes
        let osc1, osc2, sub, noise, rasp;
        let filter;

        function initAudio() {
            actx = new AC();
            
            // Master Chain
            master = actx.createGain();
            master.gain.value = 0; // Start silent, ramp up
            
            limiter = actx.createDynamicsCompressor();
            
            master.connect(limiter);
            limiter.connect(actx.destination);

            // 1. MAIN ENGINE (Sawtooth for bite)
            osc1 = actx.createOscillator();
            osc1.type = 'sawtooth';
            osc1.start();

            // 2. HARMONIC (Square for body)
            osc2 = actx.createOscillator();
            osc2.type = 'square';
            osc2.detune.value = 10; // Slight detune
            osc2.start();

            // 3. SUB (Rumble)
            sub = actx.createOscillator();
            sub.type = 'sine';
            sub.start();

            // 4. EXHAUST FILTER
            filter = actx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.Q.value = 2;

            // 5. DISTORTION (The Rasp)
            const dist = actx.createWaveShaper();
            dist.curve = makeDistortionCurve(400);

            // Routing
            osc1.connect(filter);
            osc2.connect(filter);
            sub.connect(master); // Sub bypasses filter/dist for clean bass
            
            filter.connect(dist);
            dist.connect(master);

            // Ramp up volume
            master.gain.setTargetAtTime(0.4, actx.currentTime, 1);
        }

        function makeDistortionCurve(amount) {
            const k = amount;
            const n_samples = 44100;
            const curve = new Float32Array(n_samples);
            for (let i = 0; i < n_samples; ++i) {
                const x = (i * 2) / n_samples - 1;
                curve[i] = (3 + k) * x * 20 * (Math.PI / 180) / (Math.PI + k * Math.abs(x));
            }
            return curve;
        }

        let lastGas = false;
        function updateAudio() {
            if (!actx) return;
            
            const rpm = car.rpm;
            const load = input.w ? 1 : 0;

            // Pitch Physics
            const freq = (rpm / 60) * 2; // 4 cylinder firing rate approximation
            
            osc1.frequency.setTargetAtTime(freq, actx.currentTime, 0.05);
            osc2.frequency.setTargetAtTime(freq * 1.01, actx.currentTime, 0.05);
            sub.frequency.setTargetAtTime(freq * 0.5, actx.currentTime, 0.05);

            // Filter Logic (Valves opening)
            const cutoff = 200 + (rpm * 1.2);
            filter.frequency.setTargetAtTime(cutoff, actx.currentTime, 0.1);

            // POPS AND BANGS
            if (lastGas && !input.w && rpm > 4000) {
                triggerPop();
            }
            lastGas = input.w;
        }

        function triggerPop() {
            // Quick noise burst
            const osc = actx.createOscillator();
            const g = actx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.value = 50;
            osc.frequency.exponentialRampToValueAtTime(10, actx.currentTime + 0.1);
            
            g.gain.setValueAtTime(1, actx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, actx.currentTime + 0.15);
            
            osc.connect(g);
            g.connect(master);
            osc.start();
            osc.stop(actx.currentTime + 0.15);
        }


        /* 
         * 3. PHYSICS ENGINE
         */
        function updatePhysics() {
            // Gas / Brake
            if (input.w) car.speed += car.accel;
            if (input.s) car.speed -= car.accel;

            // Friction
            car.speed *= car.friction;

            // Steering (Only when moving)
            if (Math.abs(car.speed) > 0.1) {
                // Reverse steering if going backwards
                const dir = car.speed > 0 ? 1 : -1;
                if (input.a) car.angle -= car.turnRate * dir;
                if (input.d) car.angle += car.turnRate * dir;
            }

            // Position Update
            car.x += Math.cos(car.angle) * car.speed;
            car.y += Math.sin(car.angle) * car.speed;

            // RPM Simulation
            const targetRPM = 800 + (Math.abs(car.speed) * 250);
            
            if (input.w) {
                // Rev up logic
                if (car.rpm < targetRPM) car.rpm += (targetRPM - car.rpm) * 0.2;
                else car.rpm = targetRPM;
            } else {
                // Rev drop logic
                car.rpm -= (car.rpm - 800) * 0.05;
            }
            
            // Idle jitter
            if (car.rpm < 800) car.rpm = 800 + Math.random()*50;
            // Redline
            if (car.rpm > 7000) car.rpm = 6900 + Math.random()*200;
        }


        /* 
         * 4. RENDER ENGINE
         */
        // Procedural Track
        const track = [];
        for(let i=0; i<100; i++) {
            const a = (i/100) * Math.PI * 2;
            const r = 1000 + Math.sin(a*5)*300;
            track.push({x: Math.cos(a)*r, y: Math.sin(a)*r});
        }

        function draw() {
            // Clear background (Grass)
            ctx.fillStyle = '#1b4d1b'; 
            ctx.fillRect(0, 0, width, height);

            ctx.save();
            
            // CAMERA: Center the car
            ctx.translate(width/2 - car.x, height/2 - car.y);

            // DRAW TRACK
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#333'; // Asphalt
            ctx.lineWidth = 400;
            ctx.beginPath();
            ctx.moveTo(track[0].x, track[0].y);
            for(let p of track) ctx.lineTo(p.x, p.y);
            ctx.closePath();
            ctx.stroke();

            // DRAW CURBS (Red/White)
            ctx.strokeStyle = '#d00';
            ctx.lineWidth = 420;
            ctx.setLineDash([40, 40]);
            ctx.stroke();
            ctx.setLineDash([]); // Reset

            // Re-draw Asphalt over curbs to make them edge-only
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 380;
            ctx.stroke();

            // DRAW CAR
            ctx.save();
            ctx.translate(car.x, car.y);
            ctx.rotate(car.angle);

            // Body (White)
            ctx.fillStyle = '#f0f0f0';
            ctx.beginPath();
            ctx.roundRect(-25, -14, 50, 28, 4);
            ctx.fill();

            // Heritage Hood (Black)
            ctx.fillStyle = '#111';
            ctx.fillRect(-5, -13, 30, 26);

            // Windshield
            ctx.fillStyle = '#222';
            ctx.fillRect(-10, -12, 8, 24);

            // Mirrors (Red)
            ctx.fillStyle = '#dc002e';
            ctx.fillRect(0, -16, 6, 3);
            ctx.fillRect(0, 13, 6, 3);

            // Brake Lights
            ctx.fillStyle = input.s ? '#ff0000' : '#600';
            ctx.shadowColor = '#f00';
            ctx.shadowBlur = input.s ? 20 : 0;
            ctx.fillRect(-25, -12, 2, 6);
            ctx.fillRect(-25, 6, 2, 6);
            ctx.shadowBlur = 0;

            // Headlights (Yellow beams)
            ctx.fillStyle = '#ffffee';
            ctx.fillRect(23, -12, 2, 6);
            ctx.fillRect(23, 6, 2, 6);
            
            // Headlight Beams
            ctx.globalCompositeOperation = 'screen';
            ctx.fillStyle = 'rgba(255, 255, 200, 0.3)';
            ctx.beginPath();
            ctx.moveTo(25, -10); ctx.lineTo(200, -60); ctx.lineTo(200, 60); ctx.lineTo(25, 10);
            ctx.fill();
            ctx.globalCompositeOperation = 'source-over';

            ctx.restore();
            ctx.restore();

            // HUD UPDATE
            document.getElementById('speed-val').innerText = Math.abs(Math.floor(car.speed * 3));
            document.getElementById('rpm-fill').style.width = (car.rpm / 8000 * 100) + '%';
            
            // Input Debug Vis
            document.getElementById('k-w').className = input.w ? 'key active' : 'key';
            document.getElementById('k-a').className = input.a ? 'key active' : 'key';
            document.getElementById('k-s').className = input.s ? 'key active' : 'key';
            document.getElementById('k-d').className = input.d ? 'key active' : 'key';
        }

        function loop() {
            if (!isRunning) return;
            updatePhysics();
            updateAudio();
            draw();
            requestAnimationFrame(loop);
        }

        function bootSystem() {
            document.getElementById('overlay').style.display = 'none';
            initAudio();
            isRunning = true;
            loop();
        }

        /* 
         * 5. INPUT HANDLERS
         */
        window.addEventListener('keydown', e => {
            if(e.code === 'KeyW' || e.code === 'ArrowUp') input.w = true;
            if(e.code === 'KeyS' || e.code === 'ArrowDown') input.s = true;
            if(e.code === 'KeyA' || e.code === 'ArrowLeft') input.a = true;
            if(e.code === 'KeyD' || e.code === 'ArrowRight') input.d = true;
        });

        window.addEventListener('keyup', e => {
            if(e.code === 'KeyW' || e.code === 'ArrowUp') input.w = false;
            if(e.code === 'KeyS' || e.code === 'ArrowDown') input.s = false;
            if(e.code === 'KeyA' || e.code === 'ArrowLeft') input.a = false;
            if(e.code === 'KeyD' || e.code === 'ArrowRight') input.d = false;
        });

        window.addEventListener('resize', () => {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        });

    </script>
</body>
</html>