<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BACH // BOURRÉE IN E MINOR</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=JetBrains+Mono&display=swap');

    :root {
        --bg: #1a1410;
        --ink: #f4f1ea;
        --gold: #8b7355;
        --accent: #704214;
    }

    body {
        margin: 0;
        background: var(--bg);
        overflow: hidden;
        font-family: 'Cinzel', serif;
        color: var(--ink);
        user-select: none;
    }

    #canvas {
        display: block;
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        z-index: 1;
    }

    #overlay {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: rgba(26, 20, 16, 0.95);
        z-index: 10;
        transition: opacity 0.5s;
    }

    h1 {
        font-size: 3rem;
        margin: 0;
        color: var(--ink);
        letter-spacing: 6px;
    }

    p {
        font-family: 'JetBrains Mono', monospace;
        margin-top: 15px;
        font-size: 1rem;
        color: var(--gold);
    }

    .hidden {
        opacity: 0;
        pointer-events: none;
    }

    #hud {
        position: absolute;
        bottom: 20px;
        left: 20px;
        font-family: 'JetBrains Mono', monospace;
        font-size: 12px;
        pointer-events: none;
        z-index: 5;
        color: var(--gold);
    }
</style>
</head>
<body>

<div id="overlay">
    <h1>J.S. BACH</h1>
    <p>Bourrée in E Minor, BWV 996</p>
    <p style="font-size: 0.8rem; color: #666; margin-top: 2rem;">[ CLICK TO PLAY ]</p>
</div>

<div id="hud">
    BWV 996 • E MINOR<br>
    BPM: 100
</div>

<canvas id="canvas"></canvas>

<script>
/**
 * BACH BOURRÉE ENGINE
 * Using the EXACT proven architecture
 */

// --- CONFIGURATION ---
const CONFIG = {
    BPM: 100,
    STRINGS: [64, 59, 55, 50, 45, 40],
    BASE_FREQS: [329.63, 246.94, 196.00, 146.83, 110.00, 82.41],
    STRING_NAMES: ['e', 'B', 'G', 'D', 'A', 'E']
};

// --- AUDIO ENGINE (Exact pattern from working examples) ---
const AudioEngine = {
    ctx: null,
    master: null,
    reverb: null,
    reverbGain: null,
    isPlaying: false,

    init: async () => {
        const AC = window.AudioContext || window.webkitAudioContext;
        AudioEngine.ctx = new AC();
        
        AudioEngine.master = AudioEngine.ctx.createGain();
        AudioEngine.master.gain.value = 0.5;

        // Reverb
        AudioEngine.reverb = AudioEngine.ctx.createConvolver();
        AudioEngine.reverb.buffer = await AudioEngine.createImpulse(2.0, 3.0);
        
        AudioEngine.reverbGain = AudioEngine.ctx.createGain();
        AudioEngine.reverbGain.gain.value = 0.3;

        AudioEngine.master.connect(AudioEngine.ctx.destination);
        AudioEngine.master.connect(AudioEngine.reverbGain);
        AudioEngine.reverbGain.connect(AudioEngine.reverb);
        AudioEngine.reverb.connect(AudioEngine.ctx.destination);
    },

    createImpulse: async (duration, decay) => {
        const rate = AudioEngine.ctx.sampleRate;
        const length = rate * duration;
        const impulse = AudioEngine.ctx.createBuffer(2, length, rate);
        const L = impulse.getChannelData(0);
        const R = impulse.getChannelData(1);
        for (let i = 0; i < length; i++) {
            L[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, decay);
            R[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, decay);
        }
        return impulse;
    },

    playString: (stringIdx, fret, time, duration = 1.5) => {
        if (!AudioEngine.ctx) return;
        
        const t = time;
        const baseFreq = CONFIG.BASE_FREQS[stringIdx];
        const freq = baseFreq * Math.pow(2, fret / 12);
        
        const osc1 = AudioEngine.ctx.createOscillator();
        const osc2 = AudioEngine.ctx.createOscillator();
        
        osc1.type = 'triangle';
        osc2.type = 'sine';
        
        osc1.frequency.value = freq;
        osc2.frequency.value = freq;

        const filter = AudioEngine.ctx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 2000;
        filter.Q.value = 1;

        const amp = AudioEngine.ctx.createGain();
        amp.gain.setValueAtTime(0, t);
        amp.gain.linearRampToValueAtTime(0.5, t + 0.01);
        amp.gain.exponentialRampToValueAtTime(0.001, t + duration);

        const osc1Gain = AudioEngine.ctx.createGain(); 
        osc1Gain.gain.value = 0.6;
        const osc2Gain = AudioEngine.ctx.createGain(); 
        osc2Gain.gain.value = 0.4;

        osc1.connect(osc1Gain); 
        osc1Gain.connect(filter);
        osc2.connect(osc2Gain); 
        osc2Gain.connect(filter);
        filter.connect(amp);
        amp.connect(AudioEngine.master);

        osc1.start(t); 
        osc1.stop(t + duration);
        osc2.start(t); 
        osc2.stop(t + duration);
    },

    setReverb: (val) => {
        if (AudioEngine.reverbGain) {
            AudioEngine.reverbGain.gain.setTargetAtTime(val, AudioEngine.ctx.currentTime, 0.1);
        }
    }
};

// --- TAB DATA (Exact pattern from working examples) ---
const TAB = [];
function addNote(beat, string, fret) {
    TAB.push({ beat, string, fret });
}

// Duration values
const E = 0.5;  // Eighth note
const Q = 1.0;  // Quarter note

let b = 0;

// ═══════════════════════════════════════════════════════════════
// BACH BOURRÉE IN E MINOR - From the tab provided
// ═══════════════════════════════════════════════════════════════

// [Intro] Line 1
// e|--0--2--|--3----2--0-------0--2--|-------------0----------|
// B|--------|-------------4----------|--0----2--4-------3--1--|
// E|--3--2--|--0---------------------|--3----2-----0----2-----|
// A|--------|-------0-----2----0-----|------------------------|

addNote(b, 0, 0); addNote(b, 5, 3); b += E;
addNote(b, 0, 2); addNote(b, 5, 2); b += E;
addNote(b, 0, 3); addNote(b, 5, 0); b += E;
addNote(b, 0, 2); b += E;
addNote(b, 0, 0); b += E;
addNote(b, 4, 0); b += E;
addNote(b, 1, 4); addNote(b, 4, 2); b += E;
addNote(b, 4, 0); b += E;
addNote(b, 0, 0); b += E;
addNote(b, 0, 2); b += E;

addNote(b, 0, 0); addNote(b, 5, 3); b += E;
addNote(b, 1, 0); b += E;
addNote(b, 1, 2); addNote(b, 5, 2); b += E;
addNote(b, 1, 4); b += E;
addNote(b, 5, 0); b += E;
addNote(b, 0, 0); b += E;
addNote(b, 1, 3); addNote(b, 5, 2); b += E;
addNote(b, 1, 1); b += E;

// [Intro] Line 2
// e|------------------------|--------------------0--2--|--3----2--0-------0--2--|
// B|--0---------------------|--0-----------------------|-------------4----------|
// G|-------2--0-------0--2--|-----2--0-----------------|------------------------|
// D|-------------4----------|-----------4--2-----------|------------------------|
// A|-------0-----2----0-----|--------2-----------------|-------0-----2----0-----|
// E|--3---------------------|--3-----------0--2--3--2--|--0---------------------|

addNote(b, 1, 0); addNote(b, 5, 3); b += E;
addNote(b, 2, 2); addNote(b, 4, 0); b += E;
addNote(b, 2, 0); b += E;
addNote(b, 4, 2); b += E;
addNote(b, 3, 4); addNote(b, 4, 0); b += E;
addNote(b, 2, 0); b += E;
addNote(b, 2, 2); b += E;
b += E;

addNote(b, 1, 0); addNote(b, 5, 3); b += E;
addNote(b, 2, 2); addNote(b, 4, 2); b += E;
addNote(b, 2, 0); b += E;
addNote(b, 3, 4); b += E;
addNote(b, 3, 2); addNote(b, 5, 0); b += E;
addNote(b, 5, 2); b += E;
addNote(b, 0, 0); addNote(b, 5, 3); b += E;
addNote(b, 0, 2); addNote(b, 5, 2); b += E;

addNote(b, 0, 3); addNote(b, 5, 0); b += E;
addNote(b, 0, 2); b += E;
addNote(b, 0, 0); b += E;
addNote(b, 4, 0); b += E;
addNote(b, 1, 4); addNote(b, 4, 2); b += E;
addNote(b, 4, 0); b += E;
addNote(b, 0, 0); b += E;
addNote(b, 0, 2); b += E;

// [Intro] Line 3
// e|-------------0----------|-----------------------------|
// B|--0----2--4-------3--1--|--0--------------------------|
// G|------------------------|-------2--0----------0--0----|
// D|------------------------|-------------4~5~4------0----|
// A|------------------------|-------3-----5----------2----|
// E|--3----2-----0----2-----|--3---------------------3----|

addNote(b, 0, 0); addNote(b, 5, 3); b += E;
addNote(b, 1, 0); b += E;
addNote(b, 1, 2); addNote(b, 5, 2); b += E;
addNote(b, 1, 4); b += E;
addNote(b, 5, 0); b += E;
addNote(b, 0, 0); b += E;
addNote(b, 1, 3); addNote(b, 5, 2); b += E;
addNote(b, 1, 1); b += E;

addNote(b, 1, 0); addNote(b, 5, 3); b += E;
addNote(b, 2, 2); addNote(b, 4, 3); b += E;
addNote(b, 2, 0); b += E;
addNote(b, 3, 4); addNote(b, 4, 5); b += E;
addNote(b, 3, 5); b += E;
addNote(b, 3, 4); b += E;
addNote(b, 2, 0); addNote(b, 3, 0); addNote(b, 4, 2); addNote(b, 5, 3); b += Q;

// [Ending] Line 1
// e|-------------------------3-----|--0---------------------|
// B|--0------3-------1--0-------3--|----------3--1----------|
// G|-----0--------2----------------|-------4----------4--2--|
// D|--------------0----------------|------------------0-----|
// A|-------------------------2-----|--3----------0----------|
// E|--3------2----------3----------|-------4----------------|

addNote(b, 1, 0); addNote(b, 5, 3); b += E;
addNote(b, 2, 0); b += E;
addNote(b, 1, 3); addNote(b, 5, 2); b += E;
addNote(b, 2, 2); b += E;
addNote(b, 3, 0); b += E;
addNote(b, 1, 1); b += E;
addNote(b, 1, 0); addNote(b, 5, 3); b += E;
addNote(b, 0, 3); b += E;
addNote(b, 4, 2); b += E;
addNote(b, 1, 3); b += E;

addNote(b, 0, 0); addNote(b, 4, 3); b += E;
addNote(b, 5, 4); b += E;
addNote(b, 2, 4); b += E;
addNote(b, 1, 3); b += E;
addNote(b, 1, 1); addNote(b, 4, 0); b += E;
addNote(b, 2, 4); b += E;
addNote(b, 3, 0); b += E;
addNote(b, 2, 2); b += E;

// [Ending] Line 2
// e|------------------------|-------------------------|-------3-----0----------|
// B|----------0--1----0-----|-------------------3-----|--0-------3----------3--|
// G|--1----2-------------2--|--2-------------------2--|------------------4-----|
// D|--2----------2----------|-------------------0-----|------------------------|
// A|-------0----------------|--0--2--0----------------|-------2-----3----------|
// E|------------------0-----|-----------3--2----------|--3---------------4-----|

addNote(b, 2, 1); addNote(b, 3, 2); b += E;
addNote(b, 2, 2); addNote(b, 4, 0); b += E;
addNote(b, 1, 0); b += E;
addNote(b, 1, 1); addNote(b, 3, 2); b += E;
addNote(b, 1, 0); b += E;
addNote(b, 2, 2); b += E;
addNote(b, 5, 0); b += E;
b += E;

addNote(b, 2, 2); addNote(b, 4, 0); b += E;
addNote(b, 4, 2); b += E;
addNote(b, 4, 0); b += E;
addNote(b, 5, 3); b += E;
addNote(b, 5, 2); b += E;
addNote(b, 3, 0); b += E;
addNote(b, 1, 3); addNote(b, 2, 2); b += E;
b += E;

addNote(b, 1, 0); addNote(b, 5, 3); b += E;
addNote(b, 0, 3); addNote(b, 4, 2); b += E;
addNote(b, 1, 3); b += E;
addNote(b, 4, 3); b += E;
addNote(b, 0, 0); b += E;
addNote(b, 2, 4); b += E;
addNote(b, 1, 3); addNote(b, 5, 4); b += E;
b += E;

// [Ending] Line 3
// e|-------5-----2-------0--|----------------------------|-------------------7-----|
// B|--1-------5-------2-----|--3----2--0--------------0--|--0-------------------7--|
// G|------------------------|-------------4-3-4-3-4-3----|-------------------------|
// D|-------------0----------|-------2-----4--------------|--------------1----------|
// A|--0----4----------1-----|--2-------------------------|--2--1--2--4-------------|
// E|------------------------|---------------------2------|-------------------7-----|

addNote(b, 1, 1); addNote(b, 4, 0); b += E;
addNote(b, 0, 5); addNote(b, 4, 4); b += E;
addNote(b, 1, 5); b += E;
addNote(b, 3, 0); b += E;
addNote(b, 1, 2); addNote(b, 4, 1); b += E;
addNote(b, 0, 0); b += E;
b += E;
b += E;

addNote(b, 1, 3); addNote(b, 4, 2); b += E;
addNote(b, 1, 2); addNote(b, 3, 2); b += E;
addNote(b, 1, 0); b += E;
addNote(b, 2, 4); addNote(b, 3, 4); b += E;
addNote(b, 2, 3); b += E;
addNote(b, 2, 4); b += E;
addNote(b, 2, 3); b += E;
addNote(b, 2, 4); b += E;
addNote(b, 2, 3); b += E;
addNote(b, 1, 0); addNote(b, 5, 2); b += E;

addNote(b, 1, 0); addNote(b, 4, 2); b += E;
addNote(b, 4, 1); b += E;
addNote(b, 4, 2); b += E;
addNote(b, 3, 1); addNote(b, 4, 4); b += E;
addNote(b, 0, 7); addNote(b, 5, 7); b += E;
addNote(b, 1, 7); b += E;
b += E;
b += E;

// [Ending] Line 4
// e|-------------5-------3--|--2----0-----3-------1--|--0----5--0--2-------0--|
// B|--9----7--5-------5-----|----------3-------3-----|------------------2-----|
// A|--7----5-----4----------|-------3-----2----------|--3----2-----0----------|
// E|------------------5-----|------------------3-----|------------------2-----|

addNote(b, 1, 9); addNote(b, 4, 7); b += E;
addNote(b, 1, 7); addNote(b, 4, 5); b += E;
addNote(b, 1, 5); b += E;
addNote(b, 4, 4); b += E;
addNote(b, 0, 5); addNote(b, 1, 5); b += E;
addNote(b, 0, 3); addNote(b, 5, 5); b += E;
b += E;
b += E;

addNote(b, 0, 2); addNote(b, 3, 0); b += E;
addNote(b, 0, 0); addNote(b, 4, 3); b += E;
addNote(b, 1, 3); b += E;
addNote(b, 0, 3); addNote(b, 4, 2); b += E;
addNote(b, 1, 3); b += E;
addNote(b, 0, 1); addNote(b, 5, 3); b += E;
b += E;
b += E;

addNote(b, 0, 0); addNote(b, 4, 3); b += E;
addNote(b, 0, 5); addNote(b, 4, 2); b += E;
addNote(b, 0, 0); b += E;
addNote(b, 0, 2); addNote(b, 4, 0); b += E;
addNote(b, 1, 2); b += E;
addNote(b, 0, 0); addNote(b, 5, 2); b += E;
b += E;
b += E;

// [Ending] Line 5
// e|-------------------0-----|--------------------------|-------------------------|
// B|--4-------------------0--|--1-----3-----0-----1-----|--------0----------------|
// G|-------4-----------------|-----------2-----------0--|--2-----------0----------|
// D|-------------------------|-----2--4--------1--2-----|-----------4-------4--2--|
// A|--2-------3--2--0--------|--0-----------------------|-----4--6----------0-----|
// E|-------------------4-----|--------------3-----------|--2-----------0----------|

addNote(b, 1, 4); addNote(b, 4, 2); b += E;
addNote(b, 2, 4); b += E;
addNote(b, 4, 3); b += E;
addNote(b, 4, 2); b += E;
addNote(b, 4, 0); b += E;
addNote(b, 0, 0); b += E;
addNote(b, 1, 0); addNote(b, 5, 4); b += E;
b += E;

addNote(b, 1, 1); addNote(b, 4, 0); b += E;
addNote(b, 3, 2); b += E;
addNote(b, 1, 3); addNote(b, 3, 4); b += E;
addNote(b, 2, 2); b += E;
addNote(b, 1, 0); addNote(b, 3, 1); addNote(b, 5, 3); b += E;
addNote(b, 3, 2); b += E;
addNote(b, 1, 1); addNote(b, 2, 0); b += E;
b += E;

addNote(b, 2, 2); addNote(b, 5, 2); b += E;
addNote(b, 4, 4); b += E;
addNote(b, 1, 0); addNote(b, 4, 6); b += E;
addNote(b, 2, 0); addNote(b, 5, 0); b += E;
addNote(b, 3, 4); b += E;
addNote(b, 4, 0); b += E;
addNote(b, 3, 4); b += E;
addNote(b, 3, 2); b += E;

// [Ending] Final
// e|--------------------------------------|
// B|----0-----|-------------------|
// G|-------0--|-------------------|
// D|--1----2--4-----4---4-2-4----2--------|
// A|--2----0-----2------------------------|
// E|-----------------------------0--------|----3-----|--0----------------|

addNote(b, 3, 1); addNote(b, 4, 2); b += E;
addNote(b, 1, 0); addNote(b, 3, 2); addNote(b, 4, 0); b += E;
addNote(b, 2, 0); addNote(b, 3, 4); b += E;
addNote(b, 4, 2); b += E;
addNote(b, 3, 4); b += E;
addNote(b, 3, 4); b += E;
addNote(b, 3, 2); b += E;
addNote(b, 3, 4); b += E;
addNote(b, 3, 2); addNote(b, 5, 0); b += E;
b += E;

// Final chord
addNote(b, 5, 3); b += E;
addNote(b, 0, 0); addNote(b, 4, 2); addNote(b, 3, 2); addNote(b, 5, 0); b += Q;

const LOOP_LENGTH = b + 2;

// --- SEQUENCER (Exact pattern from working examples) ---
let currentBeat = -1.0;
let startTime = 0;
let nextNoteIdx = 0;

function scheduler() {
    if (!AudioEngine.isPlaying) return;

    const currentTime = AudioEngine.ctx.currentTime;
    const elapsed = currentTime - startTime;
    currentBeat = (elapsed * (CONFIG.BPM / 60));

    if (currentBeat >= LOOP_LENGTH) {
        startTime = currentTime;
        currentBeat = 0;
        nextNoteIdx = 0;
    }

    while (nextNoteIdx < TAB.length) {
        const note = TAB[nextNoteIdx];
        if (note.beat <= currentBeat + 0.1) {
            const playTime = startTime + (note.beat * (60 / CONFIG.BPM));
            AudioEngine.playString(note.string, note.fret, playTime, 1.5);
            triggerVisual(note);
            nextNoteIdx++;
        } else {
            break;
        }
    }

    requestAnimationFrame(scheduler);
}

// --- VISUAL ENGINE (Exact pattern from working examples) ---
const cvs = document.getElementById('canvas');
const ctx = cvs.getContext('2d');
let w, h;
const activeNotes = [];

function resize() {
    w = cvs.width = window.innerWidth;
    h = cvs.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

function triggerVisual(note) {
    activeNotes.push({
        ...note,
        x: w * 0.2,
        life: 1.0,
        born: Date.now()
    });
}

function draw() {
    ctx.clearRect(0, 0, w, h);

    const STAFF_Y = h / 2;
    const SPACING = 30;
    const HIT_X = w * 0.2;

    // Staff
    ctx.lineWidth = 1;
    ctx.strokeStyle = '#3d3428';
    ctx.font = "14px 'JetBrains Mono'";
    ctx.fillStyle = '#8b7355';

    CONFIG.STRING_NAMES.forEach((name, i) => {
        const y = STAFF_Y + (i * SPACING) - (2.5 * SPACING);
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(w, y);
        ctx.stroke();
        ctx.fillText(name, 10, y + 5);
    });

    // Hit Line
    ctx.beginPath();
    ctx.moveTo(HIT_X, STAFF_Y - 100);
    ctx.lineTo(HIT_X, STAFF_Y + 100);
    ctx.strokeStyle = '#8b7355';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Notes
    const pixelsPerBeat = 140;

    ctx.font = "16px 'JetBrains Mono'";
    TAB.forEach(note => {
        let noteBeat = note.beat;
        let dist = noteBeat - currentBeat;
        if (dist < -2) dist += LOOP_LENGTH;

        const x = HIT_X + (dist * pixelsPerBeat);

        if (x > 0 && x < w) {
            const y = STAFF_Y + (note.string * SPACING) - (2.5 * SPACING);

            ctx.beginPath();
            ctx.arc(x, y, 12, 0, Math.PI * 2);
            ctx.fillStyle = '#1a1410';
            ctx.fill();
            ctx.strokeStyle = '#8b7355';
            ctx.lineWidth = 1.5;
            ctx.stroke();

            ctx.fillStyle = '#f4f1ea';
            ctx.fillText(note.fret, x - (note.fret >= 10 ? 8 : 4), y + 5);
        }
    });

    // Ripples
    for (let i = activeNotes.length - 1; i >= 0; i--) {
        const n = activeNotes[i];
        const y = STAFF_Y + (n.string * SPACING) - (2.5 * SPACING);

        const radius = 15 + ((1 - n.life) * 40);
        ctx.beginPath();
        ctx.arc(HIT_X, y, radius, 0, Math.PI * 2);
        ctx.strokeStyle = `rgba(139, 115, 85, ${n.life})`;
        ctx.lineWidth = 2;
        ctx.stroke();

        n.life -= 0.04;
        if (n.life <= 0) activeNotes.splice(i, 1);
    }

    requestAnimationFrame(draw);
}

// --- INPUTS (Exact pattern from working examples) ---
document.addEventListener('keydown', (e) => {
    if (e.code === 'Space') {
        e.preventDefault();
        togglePlay();
    }
});

document.addEventListener('click', () => {
    if (!AudioEngine.ctx) {
        AudioEngine.init();
        togglePlay();
    }
});

document.addEventListener('mousemove', (e) => {
    if (!AudioEngine.ctx) return;
    const y = e.clientY / window.innerHeight;
    AudioEngine.setReverb(y * 0.5);
});

function togglePlay() {
    if (AudioEngine.isPlaying) {
        AudioEngine.isPlaying = false;
        document.getElementById('overlay').classList.remove('hidden');
    } else {
        AudioEngine.isPlaying = true;
        document.getElementById('overlay').classList.add('hidden');
        if (startTime === 0) startTime = AudioEngine.ctx.currentTime;
        startTime = AudioEngine.ctx.currentTime - (currentBeat * (60 / CONFIG.BPM));
        scheduler();
    }
}

draw();

</script>
</body>
</html>
