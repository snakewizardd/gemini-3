<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAVID'S HARP // REDUX</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@500&display=swap');

        body {
            margin: 0;
            background-color: #050205;
            overflow: hidden;
            font-family: 'Cinzel', serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #ffd700;
        }

        canvas {
            position: absolute;
            top: 0; left: 0;
            z-index: 1;
            filter: contrast(1.2) brightness(1.2);
        }

        #ui {
            position: absolute;
            z-index: 10;
            text-align: center;
            transition: opacity 1s;
            background: radial-gradient(circle, rgba(0,0,0,0.8) 0%, transparent 70%);
            padding: 50px;
            width: 100%;
        }

        h1 {
            font-size: 3rem;
            letter-spacing: 10px;
            text-transform: uppercase;
            margin-bottom: 20px;
            text-shadow: 0 0 30px #ffd700;
        }

        button {
            background: transparent;
            color: #ffd700;
            border: 2px solid #ffd700;
            padding: 20px 60px;
            font-size: 1.5rem;
            font-family: inherit;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 5px;
            transition: 0.3s;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        }

        button:hover {
            background: #ffd700;
            color: #000;
            box-shadow: 0 0 60px #ffd700;
        }

        #status {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            font-size: 12px;
            color: rgba(255, 215, 0, 0.4);
            pointer-events: none;
            z-index: 5;
        }

    </style>
</head>
<body>

    <canvas id="harp"></canvas>

    <div id="ui">
        <h1>THE PSALMIST</h1>
        <button id="btn-start">AWAKEN THE HARP</button>
    </div>

    <div id="status">MOUSE Y: HARMONICS // MOUSE X: TEMPO</div>

    <script>
        const canvas = document.getElementById('harp');
        const ctx = canvas.getContext('2d');

        let width, height;
        let time = 0;
        let isRunning = false;
        
        // MOUSE
        let mouseX = 0.5;
        let mouseY = 0.5;

        // HARP STRINGS
        const NUM_STRINGS = 10; // 10-string Kinnor
        let strings = [];
        let particles = [];

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            initStrings();
        }
        window.addEventListener('resize', resize);

        window.addEventListener('mousemove', e => {
            mouseX = e.clientX / width;
            mouseY = e.clientY / height;
        });

        /* ------------------------------------------------
           VISUAL PHYSICS
           ------------------------------------------------ */
        class StringEntity {
            constructor(x, index) {
                this.x = x;
                this.index = index;
                this.amp = 0; // Vibration amplitude
                this.color = '#ffd700';
                this.harmonic = false;
            }

            pluck(isHarmonic) {
                this.amp = 1.0;
                this.harmonic = isHarmonic;
                // Spawn light
                for(let i=0; i<5; i++) {
                    particles.push({
                        x: this.x,
                        y: height/2 + (Math.random()-0.5)*100,
                        vx: (Math.random()-0.5)*2,
                        vy: (Math.random()-0.5)*5,
                        life: 1.0,
                        color: isHarmonic ? '#ffffff' : '#ffd700'
                    });
                }
            }

            update() {
                this.amp *= 0.95; // Decay
            }

            draw() {
                ctx.beginPath();
                
                // Color Logic: Gold for normal, White/Blue for Harmonic
                const hue = this.harmonic ? 200 : 45;
                const sat = this.harmonic ? 10 : 100;
                const light = 50 + (this.amp * 50);
                
                ctx.strokeStyle = `hsl(${hue}, ${sat}%, ${light}%)`;
                ctx.lineWidth = 1 + (this.amp * 4);
                ctx.shadowBlur = this.amp * 30;
                ctx.shadowColor = ctx.strokeStyle;

                ctx.moveTo(this.x, 0);

                // VIBRATION PHYSICS
                // Fundamental or Octave node?
                const harmonics = this.harmonic ? 2 : 1;
                
                for(let y=0; y<=height; y+=10) {
                    // Sine wave shape
                    let vib = Math.sin(time * 50 + y * 0.05) * this.amp * 10;
                    // Envelope (Fixed at ends)
                    const env = Math.sin((y/height) * Math.PI * harmonics);
                    
                    ctx.lineTo(this.x + (vib * env), y);
                }
                
                ctx.stroke();
                ctx.shadowBlur = 0;
            }
        }

        function initStrings() {
            strings = [];
            const spacing = width / (NUM_STRINGS + 1);
            for(let i=0; i<NUM_STRINGS; i++) {
                strings.push(new StringEntity(spacing * (i+1), i));
            }
        }
        resize(); // Init

        /* ------------------------------------------------
           AUDIO ENGINE: PENTATONIC LOGIC
           ------------------------------------------------ */
        const AC = window.AudioContext || window.webkitAudioContext;
        let actx, master;
        
        // C MINOR PENTATONIC (2 Octaves)
        // C3, Eb3, F3, G3, Bb3, C4, Eb4, F4, G4, Bb4
        const NOTES = [
            130.81, 155.56, 174.61, 196.00, 233.08,
            261.63, 311.13, 349.23, 392.00, 466.16
        ];

        let lastNoteIdx = 4; // Start middle

        function initAudio() {
            try {
                actx = new AC();
                master = actx.createGain();
                master.gain.value = 0.4;

                // REVERB (Holy Space)
                const conv = actx.createConvolver();
                const rate = actx.sampleRate;
                const len = rate * 4; // 4 sec tail
                const buf = actx.createBuffer(2, len, rate);
                for(let c=0; c<2; c++) {
                    const d = buf.getChannelData(c);
                    for(let i=0; i<len; i++) d[i] = (Math.random()*2-1) * Math.pow(1-i/len, 3);
                }
                conv.buffer = buf;
                
                master.connect(conv);
                conv.connect(actx.destination);
                master.connect(actx.destination);

                // Start the Loop
                playMelody();
                
                // Start Drone
                playDrone();

            } catch(e) {
                console.error("Audio Init Failed", e);
            }
        }

        function playDrone() {
            // Low C Drone
            const osc = actx.createOscillator();
            const g = actx.createGain();
            osc.type = 'triangle';
            osc.frequency.value = 65.41; // C2
            g.gain.value = 0.1;
            
            const f = actx.createBiquadFilter();
            f.type = 'lowpass';
            f.frequency.value = 200;

            osc.connect(f); f.connect(g); g.connect(master);
            osc.start();
        }

        function playNote(idx) {
            if(!strings[idx]) return;

            const t = actx.currentTime;
            const osc = actx.createOscillator();
            const gain = actx.createGain();
            const filter = actx.createBiquadFilter();

            // HARMONIC LOGIC (Mouse Y)
            // Top of screen (Y < 0.4) = Harmonics (Octave up, Sine wave)
            // Bottom of screen = Normal (Triangle wave)
            const isHarmonic = mouseY < 0.4;
            
            let freq = NOTES[idx];
            if (isHarmonic) {
                freq *= 2; // Octave up
                osc.type = 'sine'; // Pure tone
                gain.gain.setValueAtTime(0.2, t);
            } else {
                osc.type = 'triangle'; // Warm tone
                gain.gain.setValueAtTime(0.4, t);
            }

            osc.frequency.value = freq;

            // FILTER ENVELOPE (Pluck)
            filter.type = 'lowpass';
            filter.Q.value = 1;
            filter.frequency.setValueAtTime(0, t);
            filter.frequency.linearRampToValueAtTime(3000, t + 0.02); // Snap open
            filter.frequency.exponentialRampToValueAtTime(200, t + 2); // Close

            // AMP ENVELOPE
            gain.gain.exponentialRampToValueAtTime(0.001, t + 3); // Decay

            osc.connect(filter);
            filter.connect(gain);
            gain.connect(master);

            osc.start(t);
            osc.stop(t + 3.1);

            // TRIGGER VISUAL
            strings[idx].pluck(isHarmonic);
        }

        function playMelody() {
            if (!isRunning) return;

            // ALGORITHM: STEPWISE MOTION (Voice Leading)
            // Instead of random notes, we move up or down by 1 or 2 steps.
            // This creates musical phrases.
            
            const r = Math.random();
            let jump = 0;
            
            if (r < 0.4) jump = 1;       // Step Up
            else if (r < 0.8) jump = -1; // Step Down
            else if (r < 0.9) jump = 2;  // Skip Up
            else jump = -2;              // Skip Down
            
            let nextIdx = lastNoteIdx + jump;

            // Constrain to strings
            if (nextIdx < 0) nextIdx = 1;
            if (nextIdx >= NUM_STRINGS) nextIdx = NUM_STRINGS - 2;
            
            lastNoteIdx = nextIdx;

            playNote(nextIdx);

            // TEMPO (Mouse X)
            // Left = Slow (1000ms), Right = Fast (200ms)
            const speed = 1000 - (mouseX * 800);
            
            // Add randomness to rhythm for "Human" feel
            const humanize = speed + (Math.random() * 100);

            setTimeout(playMelody, humanize);
        }

        /* ------------------------------------------------
           RENDER LOOP
           ------------------------------------------------ */
        function draw() {
            if (!isRunning) return;
            requestAnimationFrame(draw);
            time += 0.02;

            // Clear
            ctx.fillStyle = 'rgba(5, 2, 5, 0.2)';
            ctx.fillRect(0, 0, width, height);

            // Background Glow (David's Star)
            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(time * 0.05);
            ctx.strokeStyle = 'rgba(255, 215, 0, 0.1)';
            ctx.lineWidth = 2;
            const r = 300;
            // Triangle 1
            ctx.beginPath();
            ctx.moveTo(0, -r); ctx.lineTo(r*0.866, r*0.5); ctx.lineTo(-r*0.866, r*0.5); ctx.closePath(); ctx.stroke();
            // Triangle 2
            ctx.beginPath();
            ctx.moveTo(0, r); ctx.lineTo(-r*0.866, -r*0.5); ctx.lineTo(r*0.866, -r*0.5); ctx.closePath(); ctx.stroke();
            ctx.restore();

            // Draw Particles
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy;
                p.life -= 0.02;
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life;
                ctx.fillRect(p.x, p.y, 2, 2);
                if(p.life <= 0) particles.splice(i, 1);
            }
            ctx.globalAlpha = 1.0;

            // Draw Strings
            strings.forEach(s => {
                s.update();
                s.draw();
            });
        }

        // START
        document.getElementById('btn-start').addEventListener('click', () => {
            document.getElementById('ui').style.opacity = 0;
            setTimeout(() => document.getElementById('ui').style.display = 'none', 1000);
            
            initAudio();
            if (actx.state === 'suspended') actx.resume();
            
            isRunning = true;
            draw();
        });

    </script>
</body>
</html>