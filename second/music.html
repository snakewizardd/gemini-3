<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOOM // REDUX</title>
    <style>
        body {
            margin: 0;
            background-color: #050505;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            color: #eee;
            user-select: none;
        }

        canvas {
            position: absolute;
            top: 0; left: 0;
            z-index: 1;
        }

        #ui-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            background: rgba(0,0,0,0.8);
            transition: opacity 0.5s;
        }

        h1 {
            font-weight: 100;
            letter-spacing: 5px;
            border-bottom: 1px solid #fff;
            padding-bottom: 10px;
        }

        button {
            background: transparent;
            color: #00ff88;
            border: 2px solid #00ff88;
            padding: 20px 50px;
            font-size: 1.2rem;
            font-family: inherit;
            cursor: pointer;
            transition: 0.2s;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        button:hover {
            background: #00ff88;
            color: #000;
            box-shadow: 0 0 30px #00ff88;
        }

        #status-bar {
            position: absolute;
            bottom: 20px;
            left: 20px;
            font-size: 12px;
            color: #888;
            z-index: 5;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <canvas id="canvas"></canvas>

    <div id="ui-layer">
        <h1>POLY-TEMPORAL LOOM</h1>
        <button id="btn-start">ACTIVATE LOOM</button>
    </div>

    <div id="status-bar">
        AUDIO ENGINE: OFFLINE<br>
        MOVE MOUSE TO WARP TIME
    </div>

    <script>
        // --- VISUAL SETUP ---
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status-bar');

        let width, height;
        let strings = [];
        const NUM_STRINGS = 32;
        
        let mouseX = 0.5;
        let mouseY = 0.5;
        let time = 0;
        let isRunning = false;

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            
            // Re-init strings positions
            strings = [];
            for(let i=0; i<NUM_STRINGS; i++) {
                strings.push({
                    x: (width / NUM_STRINGS) * i + (width/NUM_STRINGS/2),
                    amp: 0,
                    color: 0
                });
            }
        }
        window.addEventListener('resize', resize);
        resize();

        window.addEventListener('mousemove', e => {
            mouseX = e.clientX / width;
            mouseY = e.clientY / height;
            status.innerHTML = `AUDIO ENGINE: ACTIVE<br>DENSITY: ${(mouseX*100).toFixed(0)}% | HARMONIC: ${(mouseY*100).toFixed(0)}%`;
        });

        /* ------------------------------------------------
           AUDIO ENGINE (ROBUST)
           ------------------------------------------------ */
        let actx;
        let master;
        let nextNoteTime = 0;
        let beatCount = 0;

        // PENTATONIC SCALES
        const SCALES = [
            [196.00, 233.08, 261.63, 311.13, 349.23], // G Minor Pentatonic
            [261.63, 293.66, 329.63, 392.00, 440.00]  // C Major Pentatonic
        ];

        function initAudio() {
            const AudioCtor = window.AudioContext || window.webkitAudioContext;
            actx = new AudioCtor();

            // Resume context immediately (Fixes the "Silent Start" bug)
            if (actx.state === 'suspended') {
                actx.resume();
            }

            master = actx.createGain();
            master.gain.value = 0.3; // Safe volume

            // DELAY LINE (Space)
            const delay = actx.createDelay();
            delay.delayTime.value = 0.25;
            const feedback = actx.createGain();
            feedback.gain.value = 0.4;
            
            // Wiring
            master.connect(actx.destination); // Dry
            master.connect(delay); // Send to delay
            delay.connect(feedback);
            feedback.connect(delay);
            delay.connect(actx.destination); // Wet

            nextNoteTime = actx.currentTime;
            scheduler();
        }

        // SCHEDULER (The Clock)
        function scheduler() {
            // Lookahead: 0.1s
            const lookahead = 0.1;
            
            // Tempo based on Mouse X (Left = Slow, Right = Fast)
            // Range: 200ms per beat to 50ms per beat
            const beatLen = 0.25 - (mouseX * 0.2); 

            while (nextNoteTime < actx.currentTime + lookahead) {
                playStep(nextNoteTime, beatCount);
                nextNoteTime += beatLen;
                beatCount++;
            }
            
            if (isRunning) requestAnimationFrame(scheduler);
        }

        function playStep(t, beat) {
            // POLYRHYTHMS
            // We trigger notes based on modulus math
            
            // Bass: Every 8 beats
            if (beat % 8 === 0) playVoice(t, 'BASS');
            
            // Mids: Every 3 beats (Polyrhythm 3 over 4)
            if (beat % 3 === 0) playVoice(t, 'MID');
            
            // Highs: Every 5 beats (Polyrhythm 5 over 4)
            if (beat % 5 === 0) playVoice(t, 'HIGH');
            
            // Random Sparkle
            if (Math.random() > 0.8) playVoice(t, 'HIGH');
        }

        function playVoice(t, type) {
            const osc = actx.createOscillator();
            const mod = actx.createOscillator(); // FM Modulator
            const modGain = actx.createGain();
            const gain = actx.createGain();
            
            // SCALE SELECTION (Based on Mouse Y)
            const scaleIdx = mouseY > 0.5 ? 1 : 0;
            const scale = SCALES[scaleIdx];
            
            // NOTE SELECTION
            const note = scale[Math.floor(Math.random() * scale.length)];
            let freq = note;

            if (type === 'BASS') freq /= 2;
            if (type === 'HIGH') freq *= 2;

            osc.frequency.value = freq;
            osc.type = 'sine';

            // FM SYNTHESIS (The Metallic/Alien Sound)
            // Modulator ratio changes texture
            const ratio = type === 'BASS' ? 0.5 : 2.0; 
            mod.frequency.value = freq * ratio;
            mod.type = 'sine';
            
            // FM Depth increases with Mouse Y
            modGain.gain.value = mouseY * 500; 

            // ENVELOPE
            const dur = type === 'BASS' ? 0.8 : 0.3;
            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(type==='BASS'?0.4:0.1, t + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, t + dur);

            // WIRING
            mod.connect(modGain);
            modGain.connect(osc.frequency); // Modulate frequency
            osc.connect(gain);
            gain.connect(master);

            osc.start(t);
            mod.start(t);
            osc.stop(t + dur + 0.1);
            mod.stop(t + dur + 0.1);

            // VISUAL TRIGGER
            // Map note to a string index
            // Hash the time to pick a "random" but deterministic string
            const strIdx = Math.floor((t * 100) % NUM_STRINGS);
            if (strings[strIdx]) {
                strings[strIdx].amp = 1.0;
                strings[strIdx].color = type === 'BASS' ? 0 : (type === 'MID' ? 160 : 320);
            }
        }

        /* ------------------------------------------------
           RENDER ENGINE
           ------------------------------------------------ */
        function draw() {
            if (!isRunning) return;
            requestAnimationFrame(draw);
            
            time += 0.05;

            // Clear with fade (Trails)
            ctx.fillStyle = 'rgba(5, 5, 5, 0.3)';
            ctx.fillRect(0, 0, width, height);

            ctx.lineWidth = 2;

            for (let i = 0; i < strings.length; i++) {
                const s = strings[i];
                
                // Only draw active strings or faint idle ones
                const isAlive = s.amp > 0.01;
                
                ctx.strokeStyle = isAlive 
                    ? `hsl(${s.color}, 80%, 60%)` 
                    : 'rgba(50, 50, 50, 0.2)';
                
                ctx.beginPath();
                ctx.moveTo(s.x, 0);

                // Draw vibrating string
                // Amplitude depends on 'amp' state
                const vibration = isAlive ? s.amp * 30 : 0;
                
                // Draw curve
                // Simple quadratic curve to simulate string pluck
                const midY = height / 2;
                const offset = Math.sin(time * 10 + i) * vibration;
                
                ctx.quadraticCurveTo(s.x + offset, midY, s.x, height);
                ctx.stroke();

                // Decay physics
                s.amp *= 0.92;
            }
            
            // Draw Mouse Cursor Interaction
            ctx.beginPath();
            ctx.arc(mouseX * width, mouseY * height, 20, 0, Math.PI*2);
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 1;
            ctx.stroke();
        }

        /* ------------------------------------------------
           START LOGIC
           ------------------------------------------------ */
        document.getElementById('btn-start').addEventListener('click', () => {
            document.getElementById('ui-layer').style.opacity = 0;
            setTimeout(() => document.getElementById('ui-layer').style.display = 'none', 500);
            
            isRunning = true;
            initAudio();
            draw();
        });

    </script>
</body>
</html>