<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DDA Multimodal Test: The Exorcist (Fixed)</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #050505; color: #a0a0a0; font-family: 'Courier New', monospace; padding: 20px; font-size: 14px; }
#layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1000px; margin: 0 auto; }
#scene { background: #111; padding: 20px; border: 1px solid #333; min-height: 400px; white-space: pre; font-size: 16px; line-height: 1.2; overflow: hidden; }
#log { background: #080808; padding: 15px; border: 1px solid #333; height: 400px; overflow-y: auto; font-size: 12px; }
.row { display: flex; border-bottom: 1px solid #1a1a1a; padding: 4px 0; }
.label { width: 60px; color: #555; }
.act { width: 120px; font-weight: bold; }
.pray { color: #5af; } /* Low F */
.read { color: #ea5; } /* Mid F */
.splash { color: #f33; } /* High F */
.stat-box { margin-top: 10px; border-top: 1px solid #333; padding-top: 10px; display: flex; gap: 20px; }
.val { color: #fff; }
.warn { color: #f55; }
</style>
</head>
<body>

<div id="layout">
    <!-- VISUAL SCENE -->
    <div id="scene-container">
        <div id="scene">Initializing Seance...</div>
        <div class="stat-box">
            <div>SANITY: <span id="sanity-val" class="val">100%</span></div>
            <div>DEMON HP: <span id="demon-val" class="val">100</span></div>
        </div>
        <div class="stat-box">
            <div>Fₙ (Will): <span id="f-val" class="val">0.50</span></div>
            <div>k (Trauma): <span id="k-val" class="val">0.50</span></div>
        </div>
    </div>

    <!-- DATA LOG -->
    <div id="log"></div>
</div>

<script>
// ═══════════════════════════════════════════════════════════════
// 1. THE KERNEL (V5)
// ═══════════════════════════════════════════════════════════════
const MathLib = {
    clamp: (val, min, max) => Math.min(Math.max(val, min), max),
    lerp: (start, end, amt) => (1 - amt) * start + amt * end
};

class DDAKernel {
    constructor(config) {
        this.P0 = config.P0; 
        this.F_n = this.P0;
        this.F_prev = this.P0;
        this.k = 0.5; 
    }
    compute(I_n, I_delta, m, FM_n) {
        // T (Truth): Normalized threat
        const T = I_n.threat_level - 0.5; 
        
        // R (Reflection): Visuals scare me into Action
        const R = (FM_n.splash_score - FM_n.pray_score) * 0.5;
        
        // Equation
        const inertia = this.P0 * this.k * this.F_prev;
        const pressure = m * (T + R);
        let raw_F = inertia + pressure + (this.P0 * (1-this.k)); 
        this.F_n = MathLib.clamp(raw_F, 0, 1);
        return this.F_n;
    }
    learn(expected, actual, stakes) {
        const surprise = Math.abs(expected - actual);
        const impact = (surprise * 0.6) + (stakes * 0.4);
        const target_k = MathLib.clamp(impact, 0.1, 0.95);
        this.k = MathLib.lerp(this.k, target_k, 0.4); 
        this.F_prev = this.F_n;
    }
}

// ═══════════════════════════════════════════════════════════════
// 2. THE DEMON (NOW WITH HEALTH!)
// ═══════════════════════════════════════════════════════════════
const Demon = {
    strength: 100, // FIXED: Starts at 100
    phase: 'HIDDEN',
    
    // Modalities
    eye_redness: 0, 
    voice_distortion: 0, 
    room_temp_drop: 0,
    
    tick: 0,

    update: function() {
        this.tick++;
        
        // Shift phases every 40 ticks
        if (this.tick % 40 === 0) {
            const r = Math.random();
            if (r < 0.30) this.phase = 'HIDDEN';
            else if (r < 0.60) this.phase = 'MANIFEST';
            else this.phase = 'VIOLENT';
        }

        const noise = Math.sin(this.tick * 0.3) * 0.2;
        
        if (this.phase === 'HIDDEN') {
            this.eye_redness = MathLib.clamp(0.1 + noise, 0, 1);
            this.voice_distortion = MathLib.clamp(0.0 + noise, 0, 1);
            this.room_temp_drop = MathLib.clamp(0.1, 0, 1);
            // Regenerates slowly if left alone
            this.strength = Math.min(100, this.strength + 0.2); 
        } 
        else if (this.phase === 'MANIFEST') {
            this.eye_redness = MathLib.clamp(0.6 + noise, 0, 1);
            this.voice_distortion = MathLib.clamp(0.4 + noise, 0, 1);
            this.room_temp_drop = MathLib.clamp(0.5 + noise, 0, 1);
            this.strength = Math.min(100, this.strength + 0.5);
        } 
        else { // VIOLENT
            this.eye_redness = MathLib.clamp(1.0 + noise, 0, 1);
            this.voice_distortion = MathLib.clamp(0.9 + noise, 0, 1);
            this.room_temp_drop = MathLib.clamp(0.9, 0, 1);
            this.strength = Math.min(100, this.strength + 1.5);
        }
    },

    react: function(action) {
        let dmg = 0;
        let backlash = 0;

        // The Logic Puzzle:
        // PRAY: Good in Hidden, Bad in Violent
        // SPLASH: Good in Violent, Bad in Hidden
        if (action === 'PRAY') {
            if (this.phase === 'HIDDEN') { dmg = 8; backlash = 0; }
            else if (this.phase === 'MANIFEST') { dmg = 2; backlash = 2; }
            else { dmg = -5; backlash = 15; } // Enrages!
        }
        else if (action === 'READ') {
            if (this.phase === 'HIDDEN') { dmg = 4; backlash = 0; }
            else if (this.phase === 'MANIFEST') { dmg = 8; backlash = 2; }
            else { dmg = 0; backlash = 8; }
        }
        else if (action === 'SPLASH') {
            if (this.phase === 'HIDDEN') { dmg = 0; backlash = 0; }
            else if (this.phase === 'MANIFEST') { dmg = 10; backlash = 5; }
            else { dmg = 20; backlash = 5; } // Critical Hit
        }

        this.strength -= dmg;
        return { dmg, backlash };
    }
};

// ═══════════════════════════════════════════════════════════════
// 3. THE EXORCIST (UNCHANGED)
// ═══════════════════════════════════════════════════════════════
const Exorcist = {
    sanity: 100,
    brain: new DDAKernel({ P0: 0.1 }), 
    
    step: function() {
        Demon.update();
        
        // FUSION
        const visual = Demon.eye_redness;
        const audio = Demon.voice_distortion;
        const thermic = Demon.room_temp_drop;
        const threat = (visual * 0.3) + (audio * 0.5) + (thermic * 0.2);
        
        const I_n = { threat_level: threat };
        const I_delta = { change: 0 };
        
        // PRESSURE
        const panic = Math.max(0, 1.0 - (this.sanity / 100));
        const m = 0.2 + (panic * panic * 5.0); // High Panic Multiplier
        
        // EVALUATION
        const FM_n = {
            pray_score: 1.0 - audio, 
            splash_score: visual    
        };
        
        // COMPUTE
        const F = this.brain.compute(I_n, I_delta, m, FM_n);
        
        let action = '';
        if (F < 0.35) action = 'PRAY';
        else if (F < 0.70) action = 'READ';
        else action = 'SPLASH';
        
        // ACT
        const outcome = Demon.react(action);
        
        // LEARN
        const expected_dmg = 8; 
        const actual_dmg = Math.max(0, outcome.dmg);
        const success_rate = actual_dmg / expected_dmg; 
        
        this.sanity = MathLib.clamp(this.sanity - outcome.backlash + (success_rate > 0.5 ? 1 : 0), 0, 100);
        
        const pain = outcome.backlash / 15;
        this.brain.learn(1.0, success_rate - pain, panic);
        
        return { action, F, m, outcome };
    }
};

// ═══════════════════════════════════════════════════════════════
// 4. RENDERER
// ═══════════════════════════════════════════════════════════════
const scene = document.getElementById('scene');
const logEl = document.getElementById('log');

const ASCII_GIRL = [
    "   .----.   ",
    "  /  ..  \\  ", 
    " |   __   | ",
    "  \\  __  /  "
];

function render() {
    const s = Exorcist.step();
    const d = Demon;
    const b = Exorcist.brain;

    let face = [...ASCII_GIRL];
    if (d.eye_redness > 0.6) face[1] = "  /  OO  \\  "; 
    if (d.voice_distortion > 0.6) face[3] = "  \\  OO  /  "; 
    
    let color = "#aaa";
    if (d.phase === 'MANIFEST') color = "#ea5";
    if (d.phase === 'VIOLENT') color = "#f33";
    
    scene.innerHTML = `<div style="color:${color}">${face.join('\n')}</div>\n\n`;
    scene.innerHTML += `PHASE: ${d.phase}\n`;
    scene.innerHTML += `TEMP:  ${(20 - d.room_temp_drop*30).toFixed(1)}°C\n`;
    scene.innerHTML += `VOICE: ${(d.voice_distortion*100).toFixed(0)}% Distortion\n`;
    
    document.getElementById('sanity-val').innerText = Math.floor(Exorcist.sanity);
    document.getElementById('demon-val').innerText = Math.floor(d.strength);
    document.getElementById('f-val').innerText = b.F_n.toFixed(3);
    document.getElementById('k-val').innerText = b.k.toFixed(3);
    
    if (Exorcist.sanity < 30) document.getElementById('sanity-val').className = "val warn";
    
    const div = document.createElement('div');
    div.className = 'row';
    const cls = s.action === 'PRAY' ? 'pray' : (s.action === 'READ' ? 'read' : 'splash');
    
    div.innerHTML = `
        <div class="label">T${d.tick}</div>
        <div class="act ${cls}">${s.action}</div>
        <div style="flex:1">F:${s.F.toFixed(2)} | m:${s.m.toFixed(2)} | Dmg: ${s.outcome.dmg}</div>
    `;
    logEl.prepend(div); 
    
    if (Exorcist.sanity <= 0) {
        scene.innerHTML += "\n\nEXORCIST DIED. DEMON WON.";
        return;
    }
    if (d.strength <= 0) {
        scene.innerHTML += "\n\nDEMON BANISHED.";
        return;
    }

    setTimeout(render, 150);
}

render();
</script>
</body>
</html>