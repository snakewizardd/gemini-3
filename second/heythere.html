<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DELILAH // LINEAR TAPE ENGINE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Inter:wght@300;600&display=swap');

        body {
            margin: 0;
            background-color: #080808;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
        }

        /* VISUALIZER CANVAS */
        canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
            opacity: 0.7;
        }

        /* UI LAYER */
        #ui-layer {
            position: relative;
            z-index: 10;
            text-align: center;
            width: 90%;
            max-width: 900px;
            background: rgba(10, 10, 10, 0.8);
            padding: 40px;
            border: 1px solid #333;
            border-radius: 8px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
        }

        h1 {
            font-family: 'Courier Prime', monospace;
            font-size: 1rem;
            letter-spacing: 4px;
            color: #d4af37; /* Gold */
            margin-bottom: 30px;
            text-transform: uppercase;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        #lyric-display {
            font-size: 2rem;
            font-weight: 600;
            min-height: 3.5rem;
            color: #fff;
            text-shadow: 0 0 20px rgba(255,255,255,0.3);
            margin-bottom: 20px;
            transition: transform 0.1s;
        }

        #tab-display {
            font-family: 'Courier Prime', monospace;
            font-size: 14px;
            color: #00ffcc; /* Cyber Blue */
            margin-bottom: 30px;
        }

        #progress-bar {
            width: 100%;
            height: 4px;
            background: #222;
            margin-bottom: 30px;
            position: relative;
        }
        #progress-fill {
            height: 100%;
            width: 0%;
            background: #d4af37;
            box-shadow: 0 0 10px #d4af37;
            transition: width 0.1s linear;
        }

        button {
            background: transparent;
            border: 2px solid #d4af37;
            color: #d4af37;
            padding: 15px 50px;
            font-size: 1.2rem;
            font-weight: bold;
            font-family: 'Courier Prime', monospace;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
        }

        button:hover {
            background: #d4af37;
            color: #000;
            box-shadow: 0 0 30px #d4af37;
        }
        
        button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            box-shadow: none;
        }

        .bump { transform: scale(1.05); color: #ffffaa !important; }
    </style>
</head>
<body>

    <canvas id="visuals"></canvas>

    <div id="ui-layer">
        <h1>SEQUENCER: HEY THERE DELILAH</h1>
        
        <div id="lyric-display">...</div>
        
        <div id="tab-display">
            CHORD: <span id="chord-name">--</span> | STEP: <span id="step-count">0</span>
        </div>

        <div id="progress-bar"><div id="progress-fill"></div></div>

        <button id="btn-play" onclick="Engine.start()">PLAY TRACK</button>
    </div>

    <script>
        // ======================================================
        // 1. AUDIO CORE (Physical Modeling)
        // ======================================================
        const AudioCore = {
            ctx: null,
            master: null,
            reverb: null,

            init() {
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                this.master = this.ctx.createGain();
                this.master.gain.value = 0.4;

                // Convolution Reverb (The "Room")
                this.reverb = this.ctx.createConvolver();
                this.reverb.buffer = this.createImpulse(2.0, 2.5); // 2s duration

                // Signal Chain: Master -> Reverb -> Out & Master -> Out (Dry)
                this.master.connect(this.reverb);
                this.reverb.connect(this.ctx.destination);
                this.master.connect(this.ctx.destination);

                return this.ctx.resume();
            },

            createImpulse(duration, decay) {
                const rate = this.ctx.sampleRate;
                const len = rate * duration;
                const buffer = this.ctx.createBuffer(2, len, rate);
                for (let c = 0; c < 2; c++) {
                    const d = buffer.getChannelData(c);
                    for (let i = 0; i < len; i++) {
                        d[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / len, decay);
                    }
                }
                return buffer;
            },

            // The String Sound
            playString(freq, time, velocity = 1.0, isThumb = false) {
                const t = time;
                const osc = this.ctx.createOscillator();
                const filter = this.ctx.createBiquadFilter();
                const gain = this.ctx.createGain();

                // Physics: 
                // Thumb = Triangle wave (dull), Finger = Sawtooth (bright)
                osc.type = isThumb ? 'triangle' : 'sawtooth';
                osc.frequency.value = freq;

                // Filter Pluck
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(isThumb ? 600 : 3000, t);
                filter.frequency.exponentialRampToValueAtTime(100, t + 0.3); // Damping

                // Amp Envelope
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(velocity, t + 0.005); // Attack
                gain.gain.exponentialRampToValueAtTime(0.001, t + 2.5); // Release

                osc.connect(filter);
                filter.connect(gain);
                gain.connect(this.master);

                osc.start(t);
                osc.stop(t + 3.0);
            }
        };

        // ======================================================
        // 2. MUSIC THEORY & TAB DATA
        // ======================================================
        // Standard Tuning: E2 A2 D3 G3 B3 E4
        const STRINGS_HZ = [82.41, 110.00, 146.83, 196.00, 246.94, 329.63];

        function getFreq(stringIdx, fret) {
            return STRINGS_HZ[stringIdx] * Math.pow(2, fret / 12);
        }

        // TAB DEFINITIONS
        // Pattern: Bass (Thumb) on beat, Treble (Index) on off-beat
        const SHAPES = {
            'D': { 
                bass: {s: 2, f: 0}, // D string Open
                treble: [{s: 3, f: 2}, {s: 4, f: 3}] // G2, B3
            },
            'F#m': { 
                bass: {s: 2, f: 4}, // D string 4th fret
                treble: [{s: 3, f: 2}, {s: 4, f: 2}] // G2, B2
            },
            'Bm': { 
                bass: {s: 1, f: 2}, // A string 2nd fret
                treble: [{s: 3, f: 4}, {s: 4, f: 3}] // G4, B3
            },
            'G': { 
                bass: {s: 0, f: 3}, // Low E 3rd fret
                treble: [{s: 3, f: 0}, {s: 4, f: 3}] // G0, B3
            },
            'A': { 
                bass: {s: 1, f: 0}, // A string Open
                treble: [{s: 3, f: 2}, {s: 4, f: 2}] // G2, B2
            },
            // Special variation for the walkdown
            'A_Fill': {
                bass: {s: 1, f: 0},
                treble: [{s: 4, f: 2}, {s: 4, f: 0}] // B string 2 then 0
            }
        };

        // ======================================================
        // 3. LINEAR TAPE COMPILER
        // ======================================================
        const BPM = 116;
        const SPB = 60 / BPM; // Seconds per beat
        const EIGHTH = SPB / 2; 

        const Engine = {
            tape: [], // The full list of events { time, type, data }
            startTime: 0,
            cursor: 0,
            isPlaying: false,

            compile() {
                this.tape = [];
                let t = 0.0; // Relative time counter

                const addBar = (chordName, count=1) => {
                    for (let b = 0; b < count; b++) {
                        const s = SHAPES[chordName];
                        // 4 Beats per bar
                        for (let i = 0; i < 4; i++) {
                            // Downbeat (Bass)
                            this.tape.push({ 
                                time: t, type: 'NOTE', 
                                chord: chordName, 
                                s: s.bass.s, f: s.bass.f, thumb: true 
                            });
                            
                            // Upbeat (Treble)
                            s.treble.forEach((n, idx) => {
                                this.tape.push({ 
                                    time: t + EIGHTH + (idx*0.02), // Slight strum stagger
                                    type: 'NOTE', 
                                    chord: chordName, 
                                    s: n.s, f: n.f, thumb: false 
                                });
                            });
                            t += SPB;
                        }
                    }
                };

                const addHalfBar = (chordName) => {
                    const s = SHAPES[chordName];
                    for (let i = 0; i < 2; i++) { // 2 Beats
                        this.tape.push({ time: t, type: 'NOTE', chord: chordName, s: s.bass.s, f: s.bass.f, thumb: true });
                        s.treble.forEach((n, idx) => {
                            this.tape.push({ time: t + EIGHTH + (idx*0.02), type: 'NOTE', chord: chordName, s: n.s, f: n.f, thumb: false });
                        });
                        t += SPB;
                    }
                }

                const addLyric = (text) => {
                    this.tape.push({ time: t, type: 'LYRIC', text: text });
                };

                // --- SONG STRUCTURE ---
                
                // INTRO
                addBar('D'); addBar('F#m'); addBar('D'); addBar('F#m');

                // VERSE 1
                addLyric("Hey there, Delilah\nWhat's it like in New York City?");
                addBar('D'); addBar('F#m');
                
                addLyric("I'm a thousand miles away\nBut girl, tonight you look so pretty");
                addBar('D'); addBar('F#m');
                
                addLyric("Yes you do");
                addBar('D'); addBar('F#m'); // Tab shows extended Bm here usually but sticking to your requested chart of D/F#m
                
                // PRE-CHORUS
                addLyric("Times Square can't shine as bright as you");
                addBar('Bm'); 
                addHalfBar('G'); addHalfBar('A'); // Split bar
                
                addLyric("I swear it's true");
                addBar('Bm'); addBar('A');

                // VERSE 2
                addLyric("Hey there, Delilah\nDon't you worry about the distance");
                addBar('D'); addBar('F#m');
                
                addLyric("I'm right there if you get lonely\nGive this song another listen");
                addBar('D'); addBar('F#m');
                
                addLyric("Close your eyes");
                addBar('D'); addBar('F#m');

                // PRE-CHORUS 2
                addLyric("Listen to my voice, it's my disguise");
                addBar('Bm'); addHalfBar('G'); addHalfBar('A');
                
                addLyric("I'm by your side");
                addBar('Bm'); addBar('A');

                // CHORUS
                addLyric("Oh, it's what you do to me");
                addBar('D'); addBar('Bm');
                addLyric("Oh, it's what you do to me");
                addBar('D'); addBar('Bm');
                addLyric("Oh, it's what you do to me");
                addBar('D'); addBar('Bm');
                addLyric("Oh, it's what you do to me");
                addBar('D'); addBar('Bm');
                addLyric("What you do to me");
                addBar('D');

                // BRIDGE
                addLyric("A thousand miles seems pretty far");
                addBar('G');
                addLyric("But they've got planes and trains and cars");
                addBar('A');
                addLyric("I'd walk to you if I had no other way");
                addBar('D'); addBar('Bm');
                addLyric("Our friends would all make fun of us");
                addBar('G');
                addLyric("And we'll just laugh along because we know");
                addBar('A');
                addLyric("That none of them have felt this way");
                addBar('D'); addBar('Bm');
                addLyric("Delilah I can promise you");
                addBar('G');
                addLyric("That by the time we get through");
                addBar('A');
                addLyric("The world will never ever be the same");
                addBar('Bm');
                addLyric("And you're to blame");
                addBar('A'); addBar('A');

                // END
                addLyric("Hey there, Delilah... here's to you.");
                addBar('D');
                addLyric("");
                
                this.totalDuration = t;
            },

            start() {
                const btn = document.getElementById('btn-play');
                btn.disabled = true;
                btn.innerText = "PLAYING...";

                AudioCore.init().then(() => {
                    this.compile();
                    this.startTime = AudioCore.ctx.currentTime + 0.2; // Small buffer
                    this.cursor = 0;
                    this.isPlaying = true;
                    this.tick();
                });
            },

            tick() {
                if (!this.isPlaying) return;

                const now = AudioCore.ctx.currentTime;
                const lookahead = 0.1; // Schedule 100ms ahead

                // Process events
                while (this.cursor < this.tape.length) {
                    const ev = this.tape[this.cursor];
                    const evTime = this.startTime + ev.time;

                    if (evTime <= now + lookahead) {
                        // EXECUTE EVENT
                        if (ev.type === 'NOTE') {
                            const freq = getFreq(ev.s, ev.f);
                            // Schedule audio
                            AudioCore.playString(freq, evTime, 1.0, ev.thumb);
                            // Schedule UI update (approx)
                            setTimeout(() => {
                                document.getElementById('chord-name').innerText = ev.chord;
                                Visuals.pluck(ev.s);
                            }, (evTime - now) * 1000);
                        } 
                        else if (ev.type === 'LYRIC') {
                            setTimeout(() => {
                                const l = document.getElementById('lyric-display');
                                l.innerText = ev.text;
                                l.classList.remove('bump');
                                void l.offsetWidth;
                                l.classList.add('bump');
                            }, (evTime - now) * 1000);
                        }
                        this.cursor++;
                    } else {
                        break; // Next event is too far in future
                    }
                }

                // Progress Bar
                const pct = ((now - this.startTime) / this.totalDuration) * 100;
                document.getElementById('progress-fill').style.width = Math.min(pct, 100) + '%';

                if (this.cursor >= this.tape.length && (now > this.startTime + this.totalDuration + 2)) {
                    this.isPlaying = false;
                    document.getElementById('btn-play').disabled = false;
                    document.getElementById('btn-play').innerText = "REPLAY";
                } else {
                    requestAnimationFrame(this.tick.bind(this));
                }
            }
        };

        // ======================================================
        // 4. VISUALS
        // ======================================================
        const Visuals = {
            cvs: document.getElementById('visuals'),
            ctx: document.getElementById('visuals').getContext('2d'),
            strings: [0,0,0,0,0,0], // Amp of 6 strings

            init() {
                this.resize();
                window.onresize = () => this.resize();
                this.loop();
            },

            resize() {
                this.cvs.width = window.innerWidth;
                this.cvs.height = window.innerHeight;
            },

            pluck(idx) {
                // Invert index for visual layout (Low string at bottom, high at top)
                // Standard Tab: E A D G B e (0 1 2 3 4 5)
                // Visual: 0 at bottom, 5 at top
                this.strings[idx] = 30;
            },

            loop() {
                const w = this.cvs.width;
                const h = this.cvs.height;
                const ctx = this.ctx;

                ctx.clearRect(0, 0, w, h);

                const spacing = h / 8;
                const startY = h - spacing * 1.5; // Bottom up

                for (let i = 0; i < 6; i++) {
                    const y = startY - (i * spacing);
                    const amp = this.strings[i];

                    ctx.beginPath();
                    ctx.moveTo(0, y);

                    // String Color
                    ctx.strokeStyle = i < 3 ? '#d49060' : '#e0e0e0'; // Bronze vs Steel
                    ctx.lineWidth = 2 + (i < 3 ? 2 : 0); // Bass strings thicker

                    if (amp > 0.5) {
                        // Vibrating
                        for (let x = 0; x < w; x += 20) {
                            const vib = Math.sin(x * 0.05 + Date.now() * 0.2) * amp * Math.sin(x/w * Math.PI);
                            ctx.lineTo(x, y + vib);
                        }
                        this.strings[i] *= 0.92; // Decay
                    } else {
                        ctx.lineTo(w, y);
                    }
                    ctx.stroke();
                }
                requestAnimationFrame(this.loop.bind(this));
            }
        };
        Visuals.init();

    </script>
</body>
</html>