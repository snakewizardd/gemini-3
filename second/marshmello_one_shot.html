<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>THE MICRO-GROOVE // SYNCOPATION ENGINE</title>
<style>
    :root { --bg: #111; --k: #fff; --h: #0ff; --s: #ff0; --r: #f0f; }
    body {
        margin: 0; background: var(--bg); overflow: hidden;
        font-family: 'Helvetica', sans-serif; color: #eee;
        display: flex; justify-content: center; align-items: center; height: 100vh;
    }
    canvas { position: absolute; top: 0; left: 0; z-index: 1; }
    
    #ui {
        position: absolute; z-index: 10; text-align: center;
        background: rgba(17,17,17,0.95); padding: 50px; 
        border: 1px solid #333; transition: opacity 0.5s;
    }

    h1 { font-weight: 100; letter-spacing: 3px; font-size: 1.5rem; margin-bottom: 20px; }
    .status { font-size: 0.8rem; color: #666; margin-bottom: 30px; letter-spacing: 1px; }

    button {
        background: transparent; border: 1px solid #fff; color: #fff;
        padding: 15px 40px; cursor: pointer; font-size: 0.9rem;
        transition: 0.2s; letter-spacing: 2px;
    }
    button:hover { background: #fff; color: #000; }

    #readout {
        position: absolute; bottom: 40px; width: 100%; text-align: center;
        z-index: 5; font-size: 12px; color: #555; letter-spacing: 2px;
    }
    .active-element { color: #fff; font-weight: bold; }
</style>
</head>
<body>

<div id="readout">
    <span id="txt-k" style="color:#444">KICK</span> // 
    <span id="txt-h" style="color:#444">HI-HAT</span> // 
    <span id="txt-s" style="color:#444">SHAKER</span> // 
    <span id="txt-r" style="color:#444">RIM</span>
</div>

<div id="ui">
    <h1>MICRO // GROOVE</h1>
    <div class="status">SYNCOPATED PERCUSSION ENGINE</div>
    <button id="btn">INITIALIZE GROOVE</button>
</div>

<canvas id="c"></canvas>

<script>
/**
 * THE MICRO-GROOVE
 * BPM: 124
 * SWING: 25% (Roger Linn Style)
 */

const AC = window.AudioContext || window.webkitAudioContext;
const cvs = document.getElementById('c');
const ctx = cvs.getContext('2d');
let w, h;

let ac, master, limiter;
let isPlaying = false;
let startTime = 0;

// CONFIG
const BPM = 124;
const BEAT = 60 / BPM;
const SIXTEENTH = BEAT / 4;
const SWING_AMOUNT = 0.035; // The "Breath" (Delay in seconds for offbeats)

// ================= AUDIO ENGINE ================= //

async function init() {
    ac = new AC();
    await ac.resume();

    master = ac.createGain();
    master.gain.value = 0.7;

    limiter = ac.createDynamicsCompressor();
    limiter.threshold.value = -1;
    limiter.ratio.value = 20;

    master.connect(limiter).connect(ac.destination);
}

// 1. THE HEARTBEAT (Kick)
// Clean, tight, punchy. No mud.
function playKick(t) {
    const osc = ac.createOscillator();
    const g = ac.createGain();
    
    // Pitch sweep: Body
    osc.frequency.setValueAtTime(140, t);
    osc.frequency.exponentialRampToValueAtTime(45, t + 0.15);
    
    // Envelope: Tight
    g.gain.setValueAtTime(1.0, t);
    g.gain.exponentialRampToValueAtTime(0.001, t + 0.3);

    // Click (Transient)
    const c = ac.createOscillator(); c.type='square';
    const cg = ac.createGain();
    cg.gain.setValueAtTime(0.1, t);
    cg.gain.exponentialRampToValueAtTime(0.001, t + 0.01);

    osc.connect(g).connect(master);
    c.connect(cg).connect(master);
    
    osc.start(t); osc.stop(t+0.3);
    c.start(t); c.stop(t+0.01);
    
    viz.k = 1;
}

// 2. THE QUESTION (Hi-Hat)
// Crisp, metallic, syncopated.
function playHat(t, vel) {
    // FM Metallic Noise
    const ratio = 4.1; // Inharmonic
    const fund = 600;

    const car = ac.createOscillator(); car.type = 'square';
    car.frequency.value = fund;
    const mod = ac.createOscillator(); mod.type = 'square';
    mod.frequency.value = fund * ratio;
    
    const modG = ac.createGain(); modG.gain.value = 1000;
    mod.connect(modG).connect(car.frequency);

    const f = ac.createBiquadFilter(); f.type='highpass'; f.frequency.value = 6000;

    const g = ac.createGain();
    g.gain.setValueAtTime(0, t);
    g.gain.linearRampToValueAtTime(vel * 0.4, t+0.005);
    g.gain.exponentialRampToValueAtTime(0.001, t+0.06); // Very short

    car.connect(f).connect(g).connect(master);
    car.start(t); car.stop(t+0.1);
    mod.start(t); mod.stop(t+0.1);
    
    viz.h = 1;
}

// 3. THE ANSWER (Shaker)
// Breath-y, filtered noise, swinging.
function playShaker(t, accent) {
    const bufSize = ac.sampleRate * 0.1;
    const buf = ac.createBuffer(1, bufSize, ac.sampleRate);
    const d = buf.getChannelData(0);
    for(let i=0; i<bufSize; i++) d[i] = Math.random()*2-1;
    const n = ac.createBufferSource(); n.buffer = buf;

    const f = ac.createBiquadFilter(); 
    f.type = 'bandpass'; 
    f.frequency.value = 9000; 
    f.Q.value = 1;

    const g = ac.createGain();
    const vol = accent ? 0.15 : 0.05; // Ghost notes vs Accents
    
    // Soft attack (The "Ch" sound)
    g.gain.setValueAtTime(0, t);
    g.gain.linearRampToValueAtTime(vol, t + 0.01); 
    g.gain.exponentialRampToValueAtTime(0.001, t + 0.08);

    n.connect(f).connect(g).connect(master);
    n.start(t);
    viz.s = 1;
}

// 4. THE TEASE (Rim / Woodblock)
// Resonant, woody, sparse.
function playRim(t) {
    const osc = ac.createOscillator();
    osc.type = 'triangle';
    osc.frequency.value = 950; // High woodblock pitch
    
    const g = ac.createGain();
    g.gain.setValueAtTime(0, t);
    g.gain.linearRampToValueAtTime(0.6, t + 0.002); // Snap attack
    g.gain.exponentialRampToValueAtTime(0.001, t + 0.08); // No sustain

    // Bandpass for "Hollow" sound
    const f = ac.createBiquadFilter();
    f.type = 'bandpass'; f.frequency.value = 1200; f.Q.value = 2;

    osc.connect(f).connect(g).connect(master);
    osc.start(t); osc.stop(t+0.1);
    
    viz.r = 1;
}

// ================= SEQUENCER ================= //

// Patterns (16 Steps)
// 1 = Hit, 0 = Rest
const PTN = {
    KICK: [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0],
    // "Dancing around the kick" - avoiding the 1
    HAT:  [0,0,1,0, 0,1,0,1, 0,0,1,0, 1,0,1,0], 
    // "And of 2" (Step 6) and "e of 4" (Step 15)
    RIM:  [0,0,0,0, 0,0,1,0, 0,0,0,0, 0,0,0,1]
};

let nextTime = 0;
let step = 0;

function scheduler() {
    if(!isPlaying) return;
    const lookahead = 0.1;
    while(nextTime < ac.currentTime + lookahead) {
        scheduleStep(step, nextTime);
        step++;
        nextTime += SIXTEENTH;
    }
    setTimeout(scheduler, 25);
}

function scheduleStep(s, t) {
    const bar = Math.floor(s / 16);
    const bStep = s % 16;
    
    // PROGRESSIVE STRUCTURE
    let showKick = true;
    let showHat = bar >= 4;
    let showShaker = bar >= 8;
    let showRim = bar >= 12;

    // UI Updates
    updateHUD(showKick, showHat, showShaker, showRim);

    // SWING LOGIC
    // If it's an even step (0, 2, 4), it's on grid.
    // If it's an odd step (1, 3, 5), it's the "offbeat". We delay it.
    const swing = (bStep % 2 !== 0) ? SWING_AMOUNT : 0;
    const swingTime = t + swing;

    // 1. KICK (On grid)
    if (showKick && PTN.KICK[bStep]) playKick(t);

    // 2. HAT (Swung)
    if (showHat && PTN.HAT[bStep]) playHat(swingTime, 1.0);

    // 3. SHAKER (Double Time - Every Step)
    // Accent the off-beats (the "Up" stroke) to breathe
    if (showShaker) {
        const isOffbeat = bStep % 2 !== 0;
        playShaker(swingTime, isOffbeat); 
    }

    // 4. RIM (Tease - Specific spots)
    if (showRim && PTN.RIM[bStep]) playRim(swingTime);
}

function updateHUD(k, h, s, r) {
    document.getElementById('txt-k').style.color = k ? '#fff' : '#444';
    document.getElementById('txt-k').style.textShadow = k ? '0 0 10px #fff' : 'none';
    
    document.getElementById('txt-h').style.color = h ? '#0ff' : '#444';
    document.getElementById('txt-h').style.textShadow = h ? '0 0 10px #0ff' : 'none';
    
    document.getElementById('txt-s').style.color = s ? '#ff0' : '#444';
    document.getElementById('txt-s').style.textShadow = s ? '0 0 10px #ff0' : 'none';
    
    document.getElementById('txt-r').style.color = r ? '#f0f' : '#444';
    document.getElementById('txt-r').style.textShadow = r ? '0 0 10px #f0f' : 'none';
}


// ================= VISUALS ================= //

let viz = { k:0, h:0, s:0, r:0 };

function initVis() {
    w = cvs.width = window.innerWidth;
    h = cvs.height = window.innerHeight;
}
window.onresize = initVis;

function draw() {
    requestAnimationFrame(draw);
    
    // Fade background
    ctx.fillStyle = 'rgba(17,17,17,0.3)';
    ctx.fillRect(0,0,w,h);
    
    const cx = w/2;
    const cy = h/2;

    // KICK: White Pulse (Center)
    if(viz.k > 0.01) {
        viz.k *= 0.85;
        ctx.beginPath();
        ctx.arc(cx, cy, 50 + (viz.k*50), 0, Math.PI*2);
        ctx.strokeStyle = `rgba(255,255,255,${viz.k})`;
        ctx.lineWidth = 5;
        ctx.stroke();
    }

    // HAT: Cyan Glitch (Top)
    if(viz.h > 0.01) {
        viz.h *= 0.8;
        const x = cx + (Math.random()-0.5)*100;
        const y = cy - 100 + (Math.random()-0.5)*50;
        ctx.fillStyle = `rgba(0, 255, 255, ${viz.h})`;
        ctx.fillRect(x, y, 4, 20);
    }

    // SHAKER: Yellow Dust (Sides)
    if(viz.s > 0.01) {
        viz.s *= 0.7; // Fast decay
        ctx.fillStyle = `rgba(255, 255, 0, ${viz.s})`;
        // Left
        ctx.fillRect(cx - 150, cy + (Math.random()-0.5)*100, 2, 2);
        // Right
        ctx.fillRect(cx + 150, cy + (Math.random()-0.5)*100, 2, 2);
    }

    // RIM: Pink Dot (Unexpected locations)
    if(viz.r > 0.01) {
        viz.r *= 0.9;
        ctx.beginPath();
        // Fixed positions for "And of 2" and "e of 4" visuals? No, make it pop.
        ctx.arc(cx, cy - 150, 10, 0, Math.PI*2);
        ctx.fillStyle = `rgba(255, 0, 255, ${viz.r})`;
        ctx.fill();
        ctx.shadowBlur = 20;
        ctx.shadowColor = '#f0f';
        ctx.shadowBlur = 0;
    }
}

initVis();
draw();

document.getElementById('btn').addEventListener('click', async () => {
    document.getElementById('ui').style.opacity = 0;
    document.getElementById('ui').style.pointerEvents = 'none';
    
    await init();
    isPlaying = true;
    startTime = ac.currentTime + 0.1;
    nextTime = startTime;
    scheduler();
});

</script>
</body>
</html>