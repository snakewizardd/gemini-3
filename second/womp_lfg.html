<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WOLF-RAYET // WOMP CORE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0;
            background: #000;
            overflow: hidden;
            cursor: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: monospace;
        }

        canvas {
            position: absolute;
            top: 0; left: 0;
            z-index: 1;
        }

        /* Glitchy Text Overlay */
        #hud {
            position: absolute;
            z-index: 10;
            color: #0ff;
            text-align: center;
            opacity: 0.7;
            pointer-events: none;
            mix-blend-mode: hard-light;
            text-shadow: 2px 2px 0px #f0f;
            white-space: pre;
            font-size: 14px;
        }

        #start-btn {
            position: absolute;
            z-index: 100;
            border: 2px solid #0ff;
            color: #0ff;
            padding: 20px 50px;
            font-size: 24px;
            text-transform: uppercase;
            letter-spacing: 5px;
            background: rgba(0,0,0,0.8);
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 20px #0ff;
        }

        #start-btn:hover {
            background: #0ff;
            color: #000;
        }

        .fade-out {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <canvas id="c"></canvas>
    <div id="hud">SYSTEM IDLE</div>
    <div id="start-btn">INITIATE SEQUENCE</div>

    <script>
        /*
         *  WOLF-RAYET // PROCEDURAL DUBSTEP OPERA
         *  Combines Promethium-61 Atmosphere with Heavy FM Bass Synthesis
         */

        // --- GLOBAL CONFIG ---
        const BPM = 140; // Classic Dubstep Tempo
        const SECONDS_PER_BEAT = 60 / BPM;
        const SIXTEENTH = SECONDS_PER_BEAT / 4;
        
        // --- VISUAL GLOBALS ---
        let canvas = document.getElementById('c');
        let ctx = canvas.getContext('2d');
        let w, h, cx, cy;
        let hud = document.getElementById('hud');
        
        // --- AUDIO GLOBALS ---
        let actx, master, limiter;
        let nextNoteTime = 0;
        let tickCount = 0; // 16th note counter
        let phraseCount = 0;
        let barCount = 0;
        let kickVis = 0;
        let snareVis = 0;
        let wompLevel = 0; // Driven by audio to warp visuals

        // --- PROMETHEUM ATOM DATA ---
        let electrons = [];
        
        function resize() {
            w = window.innerWidth;
            h = window.innerHeight;
            canvas.width = w;
            canvas.height = h;
            cx = w/2; 
            cy = h/2;
        }
        window.addEventListener('resize', resize);
        resize();

        /* ==========================================================================
           AUDIO ENGINE: THE SYNTHS
           ========================================================================== */

        function initAudio() {
            actx = new (window.AudioContext || window.webkitAudioContext)();
            
            // MASTER CHAIN: LIMITER IS CRITICAL FOR WOMP
            limiter = actx.createDynamicsCompressor();
            limiter.threshold.value = -12;
            limiter.knee.value = 0;
            limiter.ratio.value = 20; // Hard limiting
            limiter.attack.value = 0.005;
            limiter.release.value = 0.05;

            master = actx.createGain();
            master.gain.value = 0.8;
            master.connect(limiter);
            limiter.connect(actx.destination);

            // Reverb Bus for Atmosphere (Flutes/Wolves)
            setupReverb();

            // Start Clock
            nextNoteTime = actx.currentTime + 0.1;
            requestAnimationFrame(loop); // Visual loop
            scheduler(); // Audio clock loop
        }

        let reverbNode;
        function setupReverb() {
            reverbNode = actx.createConvolver();
            // Procedural Impulse
            let len = actx.sampleRate * 4;
            let buff = actx.createBuffer(2, len, actx.sampleRate);
            for(let c=0;c<2;c++){
                let d = buff.getChannelData(c);
                for(let i=0;i<len;i++) d[i] = (Math.random()*2-1) * Math.pow(1 - i/len, 3);
            }
            reverbNode.buffer = buff;
            reverbNode.connect(master);
        }

        // --- 1. THE KICK (Seismic Event) ---
        function playKick(t) {
            kickVis = 1.5;
            let osc = actx.createOscillator();
            let gain = actx.createGain();
            
            osc.frequency.setValueAtTime(150, t);
            osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.5);
            
            gain.gain.setValueAtTime(1.0, t);
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.5);

            osc.connect(gain);
            gain.connect(limiter); // Bypass master volume gain for cleaner sidechain feel
            
            osc.start(t);
            osc.stop(t + 0.5);
        }

        // --- 2. THE SNARE (Electric Whip) ---
        function playSnare(t) {
            snareVis = 20; // Screen flash offset
            
            // Tone
            let osc = actx.createOscillator();
            osc.frequency.setValueAtTime(200, t);
            osc.frequency.exponentialRampToValueAtTime(100, t+0.2);
            let oscG = actx.createGain();
            oscG.gain.setValueAtTime(0.5, t);
            oscG.gain.exponentialRampToValueAtTime(0.01, t+0.1);
            osc.connect(oscG);
            oscG.connect(reverbNode);
            osc.start(t); 
            osc.stop(t+0.2);

            // Noise (Snap)
            let bSize = actx.sampleRate;
            let buff = actx.createBuffer(1, bSize, actx.sampleRate);
            let d = buff.getChannelData(0);
            for(let i=0;i<bSize;i++) d[i] = Math.random() * 2 - 1;
            
            let noise = actx.createBufferSource();
            noise.buffer = buff;
            
            let filt = actx.createBiquadFilter();
            filt.type = 'highpass';
            filt.frequency.value = 1000;
            
            let nG = actx.createGain();
            nG.gain.setValueAtTime(0.7, t);
            nG.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
            
            noise.connect(filt);
            filt.connect(nG);
            nG.connect(reverbNode); // Wet snare
            noise.start(t);
        }

        // --- 3. THE WOMP (FM BASS FACE) ---
        // The core logic of the track
        function playWomp(t, dur, wobbleSpeed, noteFreq = 41.2) { // E1 default
            wompLevel = 1.0; // Signal visuals

            // Carrier: Sawtooth (Rich harmonics)
            let osc1 = actx.createOscillator(); 
            osc1.type = 'sawtooth';
            osc1.frequency.value = noteFreq; 

            // Sub osc: Sine
            let sub = actx.createOscillator();
            sub.type = 'sine';
            sub.frequency.value = noteFreq;

            // FILTERS (The Vocal Tract)
            let lowpass = actx.createBiquadFilter();
            lowpass.type = 'lowpass';
            lowpass.Q.value = 12; // Screaming resonance

            let gain = actx.createGain();

            // MODULATION (The Womp Womp Womp)
            let lfo = actx.createOscillator();
            lfo.type = 'sine';
            lfo.frequency.value = (BPM / 60) * wobbleSpeed; // synced to beat

            let lfoGain = actx.createGain();
            lfoGain.gain.value = 2000; // How much it opens the filter

            lfo.connect(lfoGain);
            lfoGain.connect(lowpass.frequency);

            // Envelope to define filter center point
            lowpass.frequency.setValueAtTime(300, t); 
            // Also distort
            let dist = actx.createWaveShaper();
            dist.curve = makeDistortionCurve(100);

            // Routing
            osc1.connect(dist);
            dist.connect(lowpass);
            sub.connect(gain); // Clean sub, dry
            lowpass.connect(gain);
            gain.connect(limiter);

            // Amplitude Envelope
            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(0.8, t + 0.05);
            gain.gain.setValueAtTime(0.8, t + dur - 0.05);
            gain.gain.linearRampToValueAtTime(0, t + dur);

            osc1.start(t);
            sub.start(t);
            lfo.start(t);

            osc1.stop(t+dur);
            sub.stop(t+dur);
            lfo.stop(t+dur);
            
            // Visual fade out timer
            setTimeout(() => { wompLevel = 0; }, dur*1000);
        }

        // --- 4. ATMOSPHERIC LAYERS (From previous context) ---
        function playAtmosphere(t) {
            // Random Flute / Wolf ambience
            let osc = actx.createOscillator();
            osc.type = 'triangle';
            // Pentatonic scale degrees
            let freq = [329, 392, 440, 493, 587][Math.floor(Math.random()*5)];
            osc.frequency.value = freq;
            
            let g = actx.createGain();
            g.gain.setValueAtTime(0, t);
            g.gain.linearRampToValueAtTime(0.1, t+2);
            g.gain.linearRampToValueAtTime(0, t+8);
            
            let pan = actx.createStereoPanner();
            pan.pan.value = Math.random()*2 - 1;

            osc.connect(g);
            g.connect(pan);
            pan.connect(reverbNode);
            osc.start(t);
            osc.stop(t+8);
        }

        function makeDistortionCurve(amount) {
            let k = amount, n_samples = 44100, curve = new Float32Array(n_samples), i = 0, x;
            for ( ; i < n_samples; ++i ) {
                x = i * 2 / n_samples - 1;
                curve[i] = ( 3 + k ) * x * 20 * (Math.PI / 180) / ( Math.PI + k * Math.abs(x) );
            }
            return curve;
        }

        /* ==========================================================================
           SEQUENCER: THE BRAIN
           ========================================================================== */
        
        // E Minor: E, F#, G, A, B, C, D
        const BASS_NOTES = [41.20, 41.20, 41.20, 43.65, 36.71, 48.99]; // E, E, E, F, D, G
        
        function scheduler() {
            while (nextNoteTime < actx.currentTime + 0.1) {
                scheduleNote(tickCount, nextNoteTime);
                advanceNote();
            }
            let timerID = setTimeout(scheduler, 25.0);
        }

        function advanceNote() {
            tickCount++;
            if(tickCount === 16) {
                tickCount = 0;
                phraseCount++;
                if(phraseCount % 4 === 0) barCount++;
            }
            nextNoteTime += SIXTEENTH;
        }

        // --- COMPOSITION MAP ---
        function scheduleNote(beatNumber, t) {
            // beatNumber 0 - 15 (16th notes)
            
            // PHASE 1: ATMOSPHERE INTRO (Bars 0 - 1)
            // PHASE 2: BUILD UP (Bars 2 - 3)
            // PHASE 3: THE DROP (Bars 4+)

            // --- Background Layers (Always On) ---
            if(Math.random() < 0.1 && barCount < 4) playAtmosphere(t); // Flutes die out at drop

            if(barCount >= 0) {
                // Intro Hi-Hats
                if(beatNumber % 4 === 2) { 
                    // soft hat
                }
            }

            // --- THE BUILD UP ---
            if (barCount >= 2 && barCount < 4) {
                // Rising Snares
                if(beatNumber % 4 === 0) { // Quarter notes
                    playKick(t);
                }
                if (barCount === 3 && beatNumber % 2 === 0) { // 8th notes speed up
                    playSnare(t);
                }
                if (barCount === 3 && phraseCount % 4 === 3) { // Roll at end
                     if(beatNumber > 8) playSnare(t + (Math.random()*0.05));
                }
            }

            // --- THE DROP (BAR 4 onwards) ---
            if (barCount >= 4) {
                
                // DRUMS
                if (beatNumber === 0) playKick(t);
                if (beatNumber === 8) playSnare(t);
                
                // Shuffle kick
                if (beatNumber === 11 && Math.random()>0.5) playKick(t); 

                // WOMP BASS PATTERN
                // Pattern length is 16 ticks
                
                const note = BASS_NOTES[phraseCount % BASS_NOTES.length];
                const highNote = note * 2; 

                // Bar A: WOMP - WOMP - WOBBLE
                if (phraseCount % 2 === 0) {
                    if(beatNumber === 0) playWomp(t, SIXTEENTH * 5, 2, note); // WOOOOOMP
                    if(beatNumber === 6) playWomp(t, SIXTEENTH * 2, 6, note); // wub
                    if(beatNumber === 8) playWomp(t, SIXTEENTH * 8, 4, note); // YOI YOI YOI YOI
                } 
                // Bar B: RAPID FIRE / GLITCH
                else {
                    if(beatNumber === 0) playWomp(t, SIXTEENTH * 3, 2, note);
                    if(beatNumber === 3) playWomp(t, SIXTEENTH * 3, 4, note * 1.5); // Fifth interval
                    
                    // The "Growl" (Fast LFO)
                    if(beatNumber === 8) playWomp(t, SIXTEENTH * 4, 12, note); // GGGGGRRRRR
                    
                    // High scream end of phrase
                    if(beatNumber === 12) playWomp(t, SIXTEENTH * 4, 16, highNote); 
                }
            }

            // HUD UPDATES via main thread lookahead hack (visual only)
            setTimeout(() => {
                let txt = `BAR: ${barCount} // PHS: ${phraseCount} \n`;
                if(barCount < 2) txt += ">>> SYSTEM WARMUP... ELECTRONS STABLE";
                else if (barCount < 4) txt += ">>> PRESSURE BUILDING... 61 AGENTS SYNCING";
                else txt += "!!! QUANTUM CRITICALITY !!! WOMP CORE ENGAGED";
                
                if (beatNumber % 4 === 0) hud.innerText = txt + "\n" + Math.random().toString(2).substring(2, 10);
            }, (t - actx.currentTime) * 1000);
        }

        /* ==========================================================================
           VISUALS: QUANTUM CHAOS + ATOMIC VIBRATION
           ========================================================================== */

        class Electron {
            constructor(i) {
                this.i = i;
                this.r = 100 + (i * 2);
                this.ang = (Math.PI * 2 / 61) * i;
                this.val = i + 2; // Collatz seed
                this.color = '#fff';
            }

            draw() {
                // COLLATZ MATH
                if(kickVis > 0.5) { // Step algorithm on beats
                    if (this.val % 2 == 0) this.val = this.val / 2;
                    else this.val = (this.val * 3) + 1;
                    if(this.val < 2) this.val = Math.floor(Math.random()*500)+5;
                }

                // Radius logic: Background vs Drop
                let radius = this.r;
                if(barCount >= 4) {
                     // DURING DROP: Womp warps the orbit
                     radius += (wompLevel * Math.sin(this.val)) * 200; 
                }
                
                let x = cx + Math.cos(this.ang + tickCount*0.1) * radius;
                let y = cy + Math.sin(this.ang + tickCount*0.1) * radius;

                // Shake displacement
                x += (Math.random()-0.5) * snareVis;
                y += (Math.random()-0.5) * snareVis;

                ctx.strokeStyle = `hsla(${(this.val % 360) + (barCount >= 4 ? tickCount*10 : 0)}, 80%, 60%, 0.8)`;
                
                // LINE DRAWING STYLE (Symphonic Horizontal Entry)
                ctx.lineWidth = barCount >= 4 ? 3 : 1;
                
                ctx.beginPath();
                if(this.i % 2 === 0) {
                     // Right Horizontal scan
                     ctx.moveTo(x - (20 + wompLevel * 300), y);
                     ctx.lineTo(x + 20, y);
                } else {
                     // Left Horizontal scan
                     ctx.moveTo(x + (20 + wompLevel * 300), y);
                     ctx.lineTo(x - 20, y);
                }
                ctx.stroke();

                // Core dot
                ctx.fillStyle = '#fff';
                ctx.fillRect(x-1, y-1, 3, 3);
            }
        }

        // Init Atoms
        for(let i=0; i<61; i++) electrons.push(new Electron(i));

        function loop() {
            requestAnimationFrame(loop);
            
            // DECAY VISUALS
            kickVis *= 0.9;
            snareVis *= 0.8;

            // DRAW BACKGROUND
            ctx.fillStyle = `rgba(0,0,0, ${barCount>=4 ? 0.3 : 0.1})`; // Short trails on drop, long trails intro
            ctx.fillRect(0,0,w,h);
            
            // SCREEN SHAKE
            if(wompLevel > 0.1 || snareVis > 1) {
                let shake = (wompLevel * 10) + snareVis;
                ctx.save();
                ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake);
            }

            // MIND FUCKERY BLEND MODE
            if(wompLevel > 0.5) ctx.globalCompositeOperation = 'difference'; // Invert colors on bass wobble
            else ctx.globalCompositeOperation = 'screen';

            // THE ATOM CORE
            ctx.beginPath();
            ctx.arc(cx, cy, 10 + (kickVis*50), 0, Math.PI*2);
            ctx.strokeStyle = '#0ff';
            ctx.stroke();

            // ELECTRONS
            electrons.forEach(e => e.draw());
            
            // DROP SPECIFIC FX
            if(barCount >= 4 && wompLevel > 0.8) {
                // Glitch lines
                ctx.fillStyle = Math.random() > 0.5 ? '#f0f' : '#0ff';
                let gy = Math.random() * h;
                ctx.fillRect(0, gy, w, Math.random()*20);
            }

            if(wompLevel > 0.1 || snareVis > 1) ctx.restore(); // Undo Shake
            ctx.globalCompositeOperation = 'source-over';
        }

        // --- INTERACTION ---
        let btn = document.getElementById('start-btn');
        btn.addEventListener('click', () => {
            btn.classList.add('fade-out');
            document.body.style.cursor = 'none'; // bye bye
            initAudio();
        });

    </script>
</body>
</html>