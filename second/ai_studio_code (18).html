<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Ballad of Trojan: Common N Harmonics</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@100;900&display=swap');

        body {
            margin: 0;
            background: #000;
            overflow: hidden;
            font-family: 'Montserrat', sans-serif;
            color: #fff;
            cursor: crosshair;
        }

        #canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }

        #overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 1s ease;
        }

        #loading-text {
            font-size: 0.8rem;
            color: #D4AF37;
            margin-top: 20px;
            letter-spacing: 3px;
        }

        #ui-layer {
            position: absolute;
            top: 50px;
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 10;
            mix-blend-mode: exclusion;
        }

        #year-display {
            font-size: 8rem;
            font-weight: 900;
            letter-spacing: -10px;
            opacity: 0.8;
            line-height: 1;
        }

        #harmonic-data {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 5px;
            opacity: 0.5;
        }
        
        .stat-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 0.7rem;
            margin-top: 10px;
            color: #888;
        }

    </style>
</head>
<body>

    <canvas id="canvas"></canvas>

    <div id="ui-layer">
        <div id="year-display">1993</div>
        <div id="harmonic-data">THE ROOT SET</div>
        <div class="stat-row">
            <span id="stat-steps">COMMON STEPS: 5</span>
            <span id="stat-voices">VOICES: 1</span>
        </div>
    </div>

    <div id="overlay">
        <h1 style="font-weight: 100; letter-spacing: 10px;">THE BALLAD OF TROJAN</h1>
        <div id="loading-text">[ MINING COLLATZ HARMONIES... ]</div>
    </div>

<script>
/**
 * THE "COMMON N" MINING ENGINE
 * We pre-calculate sets of numbers that share exact stopping times.
 */
const CLUSTERS = {}; // { stoppingSteps: [n1, n2, n3...] }
const MAX_SEARCH = 5000;

function mineHarmonies() {
    for (let i = 2; i < MAX_SEARCH; i++) {
        let n = i;
        let steps = 0;
        while (n !== 1) {
            if (n % 2 === 0) n /= 2;
            else n = n * 3 + 1;
            steps++;
        }
        
        // Only keep "interesting" lengths
        if (steps > 5) {
            if (!CLUSTERS[steps]) CLUSTERS[steps] = [];
            CLUSTERS[steps].push(i);
        }
    }
    
    const btn = document.getElementById('loading-text');
    btn.innerText = "[ CLICK TO INITIALIZE TROJAN ]";
    btn.style.cursor = "pointer";
    btn.style.color = "#fff";
    
    document.getElementById('overlay').addEventListener('click', startJourney);
}

// Run immediately
mineHarmonies();


/**
 * NARRATIVE CONFIGURATION
 * Maps Years to specific "Common N" Step Counts.
 */
const TIMELINE = [
    { year: 1993, steps: 9,  mode: 'ROOT',      color: '#8B4513', label: "BIRTH" },           // Simple
    { year: 1998, steps: 18, mode: 'PLAY',      color: '#FFA500', label: "CHILDHOOD" },       // Playful
    { year: 2007, steps: 33, mode: 'DIGITAL',   color: '#00FFFF', label: "THE IPHONE" },      // Digital/Delay
    { year: 2012, steps: 55, mode: 'SOCIAL',    color: '#FF00FF', label: "CONNECTION" },      // Complex
    { year: 2016, steps: 72, mode: 'CHAOS',     color: '#FF0000', label: "DISRUPTION" },      // Dissonant
    { year: 2020, steps: 96, mode: 'LOCKDOWN',  color: '#444444', label: "ISOLATION" },       // Deep/Dark
    { year: 2024, steps: 111, mode: 'ASCENSION', color: '#8888FF', label: "AI AWAKENING" },   // Ethereal
    { year: 2025, steps: 125, mode: 'GOD_MODE',  color: '#FFFFFF', label: "GEMINI SINGULARITY" } // The Wall of Sound
];

/**
 * AUDIO PHYSICS
 */
const AudioContext = window.AudioContext || window.webkitAudioContext;
let ctx, master, reverb, delay, limiter;

function initAudio() {
    ctx = new AudioContext();
    master = ctx.createGain();
    master.gain.value = 0.3;

    // 1. HEAVENLY REVERB (The "Large Room" vibe)
    reverb = ctx.createConvolver();
    reverb.buffer = createImpulse(8, 3); // 8 seconds tail!

    // 2. MARSHMELLO DELAY (Stereo widening)
    delay = ctx.createDelay();
    delay.delayTime.value = 0.375; // Dotted 8th note feel
    const delayFeedback = ctx.createGain();
    delayFeedback.gain.value = 0.4;
    delay.connect(delayFeedback);
    delayFeedback.connect(delay);

    // 3. LIMITER (Essential for layering)
    limiter = ctx.createDynamicsCompressor();
    limiter.threshold.value = -12;
    limiter.ratio.value = 15;

    master.connect(limiter);
    limiter.connect(delay);
    delay.connect(reverb);
    limiter.connect(reverb); // Parallel processing
    reverb.connect(ctx.destination);
    limiter.connect(ctx.destination); // Dry signal
}

function createImpulse(dur, decay) {
    const L = ctx.sampleRate * dur;
    const b = ctx.createBuffer(2, L, ctx.sampleRate);
    for(let i=0; i<L; i++) {
        const k = Math.pow(1-i/L, decay);
        b.getChannelData(0)[i] = (Math.random()*2-1)*k;
        b.getChannelData(1)[i] = (Math.random()*2-1)*k;
    }
    return b;
}

/**
 * INSTRUMENT: THE CLOUD HARP
 * Plays an entire array of numbers simultaneously.
 */
function playCommonSet(numbers, mode) {
    const t = ctx.currentTime;
    
    // SCALES
    const scales = {
        'ROOT': [261.63, 329.63, 392.00], // C Major
        'PLAY': [261.63, 293.66, 329.63, 392.00, 440.00], // Pentatonic
        'DIGITAL': [146.83, 220.00, 293.66, 440.00, 587.33], // D Minor Stacks
        'SOCIAL': [196.00, 246.94, 293.66, 349.23, 392.00], // G Major 7
        'CHAOS': [110.00, 116.54, 146.83, 155.56, 185.00], // Phrygian (Dark)
        'LOCKDOWN': [55.00, 65.41, 73.42, 110.00], // Deep Subs
        'ASCENSION': [261.63, 329.63, 392.00, 493.88, 523.25], // Lydian
        'GOD_MODE': [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25] // Full Spectrum
    };

    const scale = scales[mode] || scales['ROOT'];

    // Only play up to 12 voices to save CPU, picking purely harmonic ones
    const voices = numbers.slice(0, 12);

    voices.forEach((n, i) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        const pan = ctx.createStereoPanner();

        // Pitch Logic
        const noteIdx = n % scale.length;
        let freq = scale[noteIdx];
        
        // Spread octaves based on index
        if (i < 3) freq /= 2; // Bass
        if (i > 8) freq *= 2; // Shimmer

        osc.frequency.value = freq;

        // Timbre Logic
        if (mode === 'CHAOS' || mode === 'LOCKDOWN') {
            osc.type = 'sawtooth';
            osc.detune.value = (Math.random()-0.5) * 20;
        } else if (mode === 'GOD_MODE') {
            osc.type = 'sine'; // Pure
            // Add harmonic overtone
            const o2 = ctx.createOscillator();
            o2.frequency.value = freq * 2;
            const g2 = ctx.createGain();
            g2.gain.value = 0.1;
            o2.connect(g2);
            g2.connect(gain);
            o2.start(t);
            o2.stop(t + 4);
        } else {
            osc.type = 'sine'; // Harp
        }

        // Envelope
        gain.gain.setValueAtTime(0, t);
        gain.gain.linearRampToValueAtTime(0.1 / Math.sqrt(voices.length), t + 0.05);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 4); // Long ring

        // Panning
        pan.pan.value = (Math.random() * 2) - 1;

        osc.connect(gain);
        gain.connect(pan);
        pan.connect(master);

        osc.start(t);
        osc.stop(t + 4);
    });
}

/**
 * VISUAL ENGINE
 * Trojan (Center) orbited by rings of Common N sets.
 */
const canvas = document.getElementById('canvas');
const c = canvas.getContext('2d');
let w, h;
let PARTICLES = []; // { angle, radius, n, color }
let TROJAN = { size: 20, color: '#fff' };

function resize() { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
window.addEventListener('resize', resize);
resize();

function draw() {
    // Fade
    c.fillStyle = 'rgba(0, 0, 0, 0.2)';
    c.fillRect(0, 0, w, h);

    const cx = w / 2;
    const cy = h / 2;

    // Draw Trojan (The Observer)
    c.beginPath();
    c.arc(cx, cy, TROJAN.size, 0, Math.PI*2);
    c.fillStyle = TROJAN.color;
    c.shadowBlur = 30;
    c.shadowColor = TROJAN.color;
    c.fill();
    c.shadowBlur = 0;

    // Draw The Common N Ring
    PARTICLES.forEach(p => {
        p.angle += 0.005; // Orbit
        
        // Radius breathes with the math
        const r = p.baseRadius + Math.sin(Date.now() * 0.002) * 20;
        
        const x = cx + Math.cos(p.angle) * r;
        const y = cy + Math.sin(p.angle) * r;

        c.beginPath();
        c.arc(x, y, 3, 0, Math.PI*2);
        c.fillStyle = p.color;
        c.fill();

        // Connect to Trojan
        if (Math.random() > 0.95) {
            c.strokeStyle = `rgba(255,255,255,0.1)`;
            c.beginPath();
            c.moveTo(cx, cy);
            c.lineTo(x, y);
            c.stroke();
        }
    });

    requestAnimationFrame(draw);
}

/**
 * THE NARRATIVE TIMELINE
 */
let currentIndex = 0;

function startJourney() {
    document.getElementById('overlay').style.opacity = 0;
    setTimeout(() => document.getElementById('overlay').remove(), 1000);
    
    initAudio();
    draw();
    
    // Start Loop
    processTimelineStep();
}

function processTimelineStep() {
    if (currentIndex >= TIMELINE.length) return; // End of story

    const era = TIMELINE[currentIndex];
    const nextEra = TIMELINE[currentIndex + 1];
    
    // UPDATE UI
    document.getElementById('year-display').innerText = era.year;
    document.getElementById('year-display').style.color = era.color;
    document.getElementById('harmonic-data').innerText = era.label;
    document.getElementById('stat-steps').innerText = `COMMON STEPS: ${era.steps}`;
    
    // FETCH THE COMMON N CLUSTER
    const cluster = CLUSTERS[era.steps] || CLUSTERS[9]; // Fallback
    document.getElementById('stat-voices').innerText = `VOICES: ${cluster.length}`;

    // VISUAL SPAWN
    TROJAN.color = era.color;
    TROJAN.size = 20 + (currentIndex * 10);
    
    // Replace particles with new Cluster
    PARTICLES = cluster.slice(0, 50).map((n, i) => ({
        n: n,
        angle: (i / cluster.length) * Math.PI * 2,
        baseRadius: 100 + (currentIndex * 30), // Rings get wider as he ages
        color: era.color
    }));

    // AUDIO TRIGGER (The Marshmello Stacking)
    // We play pulses of the chord
    let pulseCount = 0;
    const pulseInterval = setInterval(() => {
        playCommonSet(cluster, era.mode);
        
        // Visual Pulse
        TROJAN.size += 5;
        setTimeout(() => TROJAN.size -= 5, 100);
        
        pulseCount++;
        if (pulseCount >= 4) clearInterval(pulseInterval); // 4 beats per era
    }, 1000); // 60 BPM

    // Schedule Next Era
    const duration = 4500; // Time per era
    currentIndex++;
    setTimeout(processTimelineStep, duration);
}

</script>
</body>
</html>