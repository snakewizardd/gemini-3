<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COBAIN // GENERATIVE GRUNGE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Special+Elite&display=swap');

        body {
            margin: 0;
            background-color: #1a1a1a;
            overflow: hidden;
            font-family: 'Special Elite', cursive; /* Typewriter font */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #d4d4d4;
            cursor: crosshair;
        }

        canvas {
            position: absolute;
            top: 0; left: 0;
            z-index: 1;
            filter: contrast(1.5) sepia(0.5) grayscale(0.5);
        }

        /* CRT STATIC OVERLAY */
        #static {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAIklEQVQIW2NkQAKrVq36zwjjgzhhYWGMYAEYB8RmROaABADeOQ8CXl/xfgAAAABJRU5ErkJggg==');
            opacity: 0.1;
            pointer-events: none;
            z-index: 5;
            animation: noise 0.1s infinite;
        }

        @keyframes noise { 0% { background-position: 0 0; } 100% { background-position: 10px 10px; } }

        #ui {
            position: absolute;
            z-index: 10;
            text-align: center;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle, rgba(0,0,0,0.9), #000);
            transition: opacity 2s;
        }

        h1 {
            font-size: 4rem;
            color: #b33939; /* Dried Blood Red */
            text-shadow: 2px 2px 0px #000;
            margin-bottom: 20px;
            transform: rotate(-2deg);
        }

        p {
            font-size: 1.2rem;
            color: #aaa;
            max-width: 600px;
        }

        button {
            background: #b33939;
            color: #fff;
            border: none;
            padding: 15px 40px;
            font-size: 1.5rem;
            font-family: inherit;
            cursor: pointer;
            margin-top: 30px;
            transform: rotate(1deg);
            transition: 0.2s;
            box-shadow: 5px 5px 0 #000;
        }

        button:hover {
            background: #fff;
            color: #b33939;
            transform: scale(1.05) rotate(-1deg);
        }

        #lyrics {
            position: absolute;
            bottom: 50px;
            width: 100%;
            text-align: center;
            font-size: 1.5rem;
            color: #fff;
            text-shadow: 0 0 10px #000;
            z-index: 8;
            opacity: 0;
            transition: opacity 0.2s;
        }

    </style>
</head>
<body>

    <div id="static"></div>
    <canvas id="canvas"></canvas>

    <div id="ui">
        <h1>LITHIUM PROTOCOL</h1>
        <p>GENERATIVE GRUNGE // INFINITE ABRASION</p>
        <button onclick="plugIn()">PLUG IN</button>
    </div>

    <div id="lyrics"></div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const lyricEl = document.getElementById('lyrics');

        let width, height, cx, cy;
        let time = 0;
        let isRunning = false;
        
        // STATE
        let angstLevel = 0; // 0 = Clean, 1 = Distorted
        let feedback = 0;

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            cx = width / 2;
            cy = height / 2;
        }
        window.addEventListener('resize', resize);
        resize();

        /* ------------------------------------------------
           VISUAL ENGINE: ANATOMICAL SKETCHBOOK
           ------------------------------------------------ */
        
        function drawScribble(x, y, radius, intensity) {
            ctx.beginPath();
            const steps = 20 + (intensity * 50);
            for(let i=0; i<steps; i++) {
                const ang = Math.random() * Math.PI * 2;
                const r = Math.random() * radius;
                const px = x + Math.cos(ang) * r;
                const py = y + Math.sin(ang) * r;
                if(i===0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.strokeStyle = intensity > 0.5 ? '#b33939' : '#555'; // Red or Grey
            ctx.lineWidth = 1 + (intensity * 2);
            ctx.stroke();
        }

        function drawSun() {
            // The "Black Hole Sun" / In Utero Circle
            const pulse = 1 + (angstLevel * 0.5) + (Math.sin(time * 10) * 0.1);
            
            ctx.save();
            ctx.translate(cx, cy);
            
            // Nervous shaking
            if(angstLevel > 0.8) {
                ctx.translate((Math.random()-0.5)*10, (Math.random()-0.5)*10);
            }

            // Rays
            ctx.strokeStyle = `rgba(200, 200, 200, ${0.1 + angstLevel*0.4})`;
            ctx.lineWidth = 2;
            for(let i=0; i<20; i++) {
                ctx.beginPath();
                ctx.rotate(time * 0.1 + i);
                ctx.moveTo(50 * pulse, 0);
                ctx.lineTo(width, (Math.random()-0.5)*200);
                ctx.stroke();
            }

            // Core
            ctx.beginPath();
            ctx.arc(0, 0, 50 * pulse, 0, Math.PI*2);
            ctx.fillStyle = angstLevel > 0.5 ? '#000' : '#fff'; // Inverts on drop
            ctx.fill();
            ctx.strokeStyle = '#b33939';
            ctx.stroke();

            // Messy Halo
            drawScribble(0, 0, 70 * pulse, angstLevel);

            ctx.restore();
        }

        function render() {
            if (!isRunning) return;
            requestAnimationFrame(render);
            time += 0.02;

            // Trail effect (Heavy drag)
            ctx.fillStyle = 'rgba(26, 26, 26, 0.2)';
            ctx.fillRect(0, 0, width, height);

            drawSun();

            // Feedback Visuals
            if (feedback > 0.1) {
                ctx.fillStyle = `rgba(255, 255, 255, ${feedback * 0.2})`;
                ctx.fillRect(0, 0, width, height);
            }
        }

        /* ------------------------------------------------
           AUDIO ENGINE: THE COBAIN SIMULATOR
           ------------------------------------------------ */
        const AC = window.AudioContext || window.webkitAudioContext;
        let actx, master;
        let distNode, driveNode;
        let isDistorted = false;

        // SCALE: Chromatic/Punk logic (Power Chords)
        // E Major / G Major / A Major / C Major (The "Smells Like" intervals)
        const ROOT = 82.41; // Low E
        const CHORDS = [
            ROOT,          // E
            ROOT * 1.189,  // G
            ROOT * 1.334,  // A
            ROOT * 1.587   // C
        ];

        let nextNoteTime = 0;
        let bar = 0;

        function initAudio() {
            actx = new AC();
            master = actx.createGain();
            master.gain.value = 0.6;

            // 1. DISTORTION PEDAL (The "Boss DS-1")
            distNode = actx.createWaveShaper();
            distNode.curve = makeDistortionCurve(0); // Start clean
            distNode.oversample = '4x';

            // 2. CHORUS PEDAL (The "Small Clone")
            // Delay line modulated by LFO
            const delay = actx.createDelay();
            delay.delayTime.value = 0.03;
            const lfo = actx.createOscillator();
            lfo.frequency.value = 2; // Slow wobble
            const lfoG = actx.createGain();
            lfoG.gain.value = 0.002; // Depth
            lfo.connect(lfoG);
            lfoG.connect(delay.delayTime);
            lfo.start();

            // WIRING
            // Guitar -> Distortion -> Chorus -> Master
            driveNode = actx.createGain(); // Controls input to distortion
            driveNode.gain.value = 1.0;

            driveNode.connect(distNode);
            distNode.connect(delay);
            delay.connect(master);
            
            // Dry path for bass
            distNode.connect(master); 

            master.connect(actx.destination);

            nextNoteTime = actx.currentTime + 0.1;
            playLoop();
        }

        function makeDistortionCurve(amount) {
            const k = amount;
            const n_samples = 44100;
            const curve = new Float32Array(n_samples);
            const deg = Math.PI / 180;
            for (let i = 0; i < n_samples; ++i) {
                const x = (i * 2) / n_samples - 1;
                // Soft clipping sigmoid
                curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));
            }
            return curve;
        }

        function togglePedal(dirty) {
            isDistorted = dirty;
            angstLevel = dirty ? 1.0 : 0.0;
            
            // Ramp distortion amount
            const amount = dirty ? 800 : 0; // 800 = Fuzz, 0 = Clean
            distNode.curve = makeDistortionCurve(amount);
            
            // Volume compensation
            // Clean needs to be quiet, Dirty needs to be LOUD
            const vol = dirty ? 0.8 : 0.4;
            driveNode.gain.setTargetAtTime(vol, actx.currentTime, 0.1);
        }

        /* --- THE GUITARIST --- */

        function strumChord(freq, t, type) {
            // Power Chord: Root + 5th + Octave
            const notes = [freq, freq * 1.498, freq * 2];
            
            notes.forEach((f, i) => {
                const osc = actx.createOscillator();
                const g = actx.createGain();
                
                // Imperfection: Detune slightly
                const detune = (Math.random() - 0.5) * 15;
                osc.detune.value = detune;

                if (type === 'CLEAN') {
                    osc.type = 'triangle'; // Hollow
                } else {
                    osc.type = 'sawtooth'; // Buzzy
                }
                osc.frequency.value = f;

                g.gain.setValueAtTime(0, t);
                // Humanize: Strum delay (downstroke)
                const strumDelay = i * 0.03; 
                
                g.gain.linearRampToValueAtTime(0.5, t + strumDelay + 0.05);
                g.gain.exponentialRampToValueAtTime(0.001, t + strumDelay + 1.5);

                osc.connect(g);
                g.connect(driveNode);
                
                osc.start(t + strumDelay);
                osc.stop(t + 2.0);
            });
        }

        function playDrums(t, heavy) {
            // KICK
            const kickOsc = actx.createOscillator();
            const kickG = actx.createGain();
            kickOsc.frequency.setValueAtTime(100, t);
            kickOsc.frequency.exponentialRampToValueAtTime(0.01, t + 0.5);
            kickG.gain.setValueAtTime(1, t);
            kickG.gain.exponentialRampToValueAtTime(0.01, t + 0.5);
            kickOsc.connect(kickG); kickG.connect(master);
            kickOsc.start(t); kickOsc.stop(t+0.5);

            // SNARE (Only if heavy)
            if (heavy) {
                const snareG = actx.createGain();
                const noise = actx.createBufferSource();
                const buf = actx.createBuffer(1, actx.sampleRate*0.2, actx.sampleRate);
                for(let i=0;i<buf.length;i++) buf.getChannelData(0)[i] = Math.random()*2-1;
                noise.buffer = buf;
                snareG.gain.setValueAtTime(0.8, t + 0.5); // Beat 2 (approx)
                snareG.gain.exponentialRampToValueAtTime(0.01, t + 0.7);
                noise.connect(snareG); snareG.connect(master);
                noise.start(t+0.5);
            }
        }

        function playLoop() {
            // STRUCTURE: 4 Bars Clean -> 4 Bars Dirty -> Repeat
            const isDirty = bar >= 4;
            if (bar === 4 && !isDistorted) togglePedal(true);
            if (bar === 8) {
                bar = 0;
                togglePedal(false);
                
                // Feedback Squeal on transition
                playFeedback();
            }

            // RHYTHM
            const beatLen = 0.5; // 120 BPM
            const now = nextNoteTime;

            // Chord Progression
            const chordIdx = bar % 4;
            const root = CHORDS[chordIdx];

            // Strum Pattern (Down, Down-Up-Down)
            const type = isDirty ? 'DIRTY' : 'CLEAN';
            
            strumChord(root, now, type);
            strumChord(root, now + beatLen * 1.5, type); // Syncopated
            strumChord(root, now + beatLen * 2.5, type);
            
            // Lyrics trigger (Visual)
            if (bar === 4) showLyric("I'M SO UGLY");
            if (bar === 6) showLyric("BUT THAT'S OKAY");
            if (bar === 0) showLyric("SUNDAY MORNING");

            // Drums (Simple Rock Beat)
            playDrums(now, isDirty);
            playDrums(now + beatLen, isDirty);
            playDrums(now + beatLen*2, isDirty);
            playDrums(now + beatLen*3, isDirty);

            bar++;
            nextNoteTime += (beatLen * 4); // Advance 1 bar
            
            setTimeout(playLoop, (nextNoteTime - actx.currentTime) * 1000 - 100);
        }

        function playFeedback() {
            // Self-Oscillation Squeal
            feedback = 1.0;
            const osc = actx.createOscillator();
            const g = actx.createGain();
            osc.type = 'sine';
            osc.frequency.value = 3000; // High feedback pitch
            osc.frequency.linearRampToValueAtTime(2500, actx.currentTime + 1.0);
            
            g.gain.setValueAtTime(0, actx.currentTime);
            g.gain.linearRampToValueAtTime(0.2, actx.currentTime + 0.5);
            g.gain.linearRampToValueAtTime(0, actx.currentTime + 1.5);
            
            osc.connect(g); g.connect(driveNode); // Feed into distortion
            osc.start(); osc.stop(actx.currentTime + 2);
            
            setTimeout(() => feedback = 0, 1500);
        }

        function showLyric(text) {
            lyricEl.innerText = text;
            lyricEl.style.opacity = 1;
            setTimeout(() => lyricEl.style.opacity = 0, 1500);
        }

        function plugIn() {
            document.getElementById('ui').style.opacity = 0;
            setTimeout(() => document.getElementById('ui').style.display = 'none', 2000);
            
            initAudio();
            if (actx.state === 'suspended') actx.resume();
            
            isRunning = true;
            render();
        }

    </script>
</body>
</html>